<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.75">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>computational-linear-algebra - 2. Topic Modeling with NMF and SVD</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: 1;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="computational-linear-algebra - 2. Topic Modeling with NMF and SVD">
<meta property="og:description" content="You can read an overview of this Numerical Linear Algebra course in this blog post. The course was originally taught in the University of San Francisco MS in Analytics graduate program.">
<meta property="og:site-name" content="computational-linear-algebra">
<meta name="twitter:title" content="computational-linear-algebra - 2. Topic Modeling with NMF and SVD">
<meta name="twitter:description" content="You can read an overview of this Numerical Linear Algebra course in this blog post. The course was originally taught in the University of San Francisco MS in Analytics graduate program.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">computational-linear-algebra</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/xrsrke/computational-linear-algebra"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">2. Topic Modeling with NMF and SVD</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">computational-linear-algebra</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core.html" class="sidebar-item-text sidebar-link">core</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_matrix_math_accuracy_memory_speed_parallelization.html" class="sidebar-item-text sidebar-link">1. Matrix Math, Accuracy, Memory, Speed, &amp; Parallelization</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">fastai_nbs</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/0. Course Logistics.html" class="sidebar-item-text sidebar-link">0. Course Logistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/1. Why are we here.html" class="sidebar-item-text sidebar-link">1. Why are we here?</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/2. Topic Modeling with NMF and SVD.html" class="sidebar-item-text sidebar-link active">2. Topic Modeling with NMF and SVD</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/3. Background Removal with Robust PCA.html" class="sidebar-item-text sidebar-link">3. Background Removal with Robust PCA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/4. Compressed Sensing of CT Scans with Robust Regression.html" class="sidebar-item-text sidebar-link">4. Compressed Sensing of CT Scans with Robust Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/5. Health Outcomes with Linear Regression.html" class="sidebar-item-text sidebar-link">5. Health Outcomes with Linear Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/6. How to Implement Linear Regression.html" class="sidebar-item-text sidebar-link">6. How to Implement Linear Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/7. PageRank with Eigen Decompositions.html" class="sidebar-item-text sidebar-link">7. PageRank with Eigen Decompositions</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/8. Implementing QR Factorization.html" class="sidebar-item-text sidebar-link">8. Implementing QR Factorization</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/Homework 1.html" class="sidebar-item-text sidebar-link">Homework 1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/Homework 2.html" class="sidebar-item-text sidebar-link">Homework 2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/Homework 3.html" class="sidebar-item-text sidebar-link">Homework 3</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/convolution-intro.html" class="sidebar-item-text sidebar-link">Intro to Convolutions</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/gradient-descent-intro.html" class="sidebar-item-text sidebar-link">Gradient Descent Intro</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#motivation" id="toc-motivation" class="nav-link active" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#in-todays-class" id="toc-in-todays-class" class="nav-link" data-scroll-target="#in-todays-class">In today’s class</a></li>
  <li><a href="#additional-resources" id="toc-additional-resources" class="nav-link" data-scroll-target="#additional-resources">Additional Resources</a>
  <ul>
  <li><a href="#other-tutorials" id="toc-other-tutorials" class="nav-link" data-scroll-target="#other-tutorials">Other Tutorials</a></li>
  </ul></li>
  <li><a href="#set-up-data" id="toc-set-up-data" class="nav-link" data-scroll-target="#set-up-data">Set up data</a></li>
  <li><a href="#singular-value-decomposition-svd" id="toc-singular-value-decomposition-svd" class="nav-link" data-scroll-target="#singular-value-decomposition-svd">Singular Value Decomposition (SVD)</a>
  <ul>
  <li><a href="#answer" id="toc-answer" class="nav-link" data-scroll-target="#answer">Answer</a></li>
  <li><a href="#answer-1" id="toc-answer-1" class="nav-link" data-scroll-target="#answer-1">Answer</a></li>
  <li><a href="#topics" id="toc-topics" class="nav-link" data-scroll-target="#topics">Topics</a></li>
  </ul></li>
  <li><a href="#non-negative-matrix-factorization-nmf" id="toc-non-negative-matrix-factorization-nmf" class="nav-link" data-scroll-target="#non-negative-matrix-factorization-nmf">Non-negative Matrix Factorization (NMF)</a>
  <ul>
  <li><a href="#motivation-1" id="toc-motivation-1" class="nav-link" data-scroll-target="#motivation-1">Motivation</a></li>
  <li><a href="#idea" id="toc-idea" class="nav-link" data-scroll-target="#idea">Idea</a></li>
  <li><a href="#applications-of-nmf" id="toc-applications-of-nmf" class="nav-link" data-scroll-target="#applications-of-nmf">Applications of NMF</a></li>
  <li><a href="#nmf-from-sklearn" id="toc-nmf-from-sklearn" class="nav-link" data-scroll-target="#nmf-from-sklearn">NMF from sklearn</a></li>
  <li><a href="#tf-idf" id="toc-tf-idf" class="nav-link" data-scroll-target="#tf-idf">TF-IDF</a></li>
  <li><a href="#nmf-in-summary" id="toc-nmf-in-summary" class="nav-link" data-scroll-target="#nmf-in-summary">NMF in summary</a></li>
  <li><a href="#nmf-from-scratch-in-numpy-using-sgd" id="toc-nmf-from-scratch-in-numpy-using-sgd" class="nav-link" data-scroll-target="#nmf-from-scratch-in-numpy-using-sgd">NMF from scratch in numpy, using SGD</a>
  <ul class="collapse">
  <li><a href="#gradient-descent" id="toc-gradient-descent" class="nav-link" data-scroll-target="#gradient-descent">Gradient Descent</a></li>
  <li><a href="#stochastic-gradient-descent-sgd" id="toc-stochastic-gradient-descent-sgd" class="nav-link" data-scroll-target="#stochastic-gradient-descent-sgd">Stochastic Gradient Descent (SGD)</a></li>
  <li><a href="#applying-sgd-to-nmf" id="toc-applying-sgd-to-nmf" class="nav-link" data-scroll-target="#applying-sgd-to-nmf">Applying SGD to NMF</a></li>
  </ul></li>
  <li><a href="#pytorch" id="toc-pytorch" class="nav-link" data-scroll-target="#pytorch">PyTorch</a></li>
  <li><a href="#pytorch-autograd" id="toc-pytorch-autograd" class="nav-link" data-scroll-target="#pytorch-autograd">PyTorch: autograd</a>
  <ul class="collapse">
  <li><a href="#pytorch-autograd-introduction" id="toc-pytorch-autograd-introduction" class="nav-link" data-scroll-target="#pytorch-autograd-introduction">PyTorch Autograd Introduction</a></li>
  <li><a href="#using-autograd-for-nmf" id="toc-using-autograd-for-nmf" class="nav-link" data-scroll-target="#using-autograd-for-nmf">Using Autograd for NMF</a></li>
  </ul></li>
  <li><a href="#comparing-approaches" id="toc-comparing-approaches" class="nav-link" data-scroll-target="#comparing-approaches">Comparing Approaches</a>
  <ul class="collapse">
  <li><a href="#scikit-learns-nmf" id="toc-scikit-learns-nmf" class="nav-link" data-scroll-target="#scikit-learns-nmf">Scikit-Learn’s NMF</a></li>
  <li><a href="#using-pytorch-and-sgd" id="toc-using-pytorch-and-sgd" class="nav-link" data-scroll-target="#using-pytorch-and-sgd">Using PyTorch and SGD</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#truncated-svd" id="toc-truncated-svd" class="nav-link" data-scroll-target="#truncated-svd">Truncated SVD</a>
  <ul>
  <li><a href="#shortcomings-of-classical-algorithms-for-decomposition" id="toc-shortcomings-of-classical-algorithms-for-decomposition" class="nav-link" data-scroll-target="#shortcomings-of-classical-algorithms-for-decomposition">Shortcomings of classical algorithms for decomposition:</a></li>
  <li><a href="#advantages-of-randomized-algorithms" id="toc-advantages-of-randomized-algorithms" class="nav-link" data-scroll-target="#advantages-of-randomized-algorithms">Advantages of randomized algorithms:</a></li>
  <li><a href="#randomized-svd" id="toc-randomized-svd" class="nav-link" data-scroll-target="#randomized-svd">Randomized SVD</a></li>
  <li><a href="#implementing-our-own-randomized-svd" id="toc-implementing-our-own-randomized-svd" class="nav-link" data-scroll-target="#implementing-our-own-randomized-svd">Implementing our own Randomized SVD</a>
  <ul class="collapse">
  <li><a href="#answer-2" id="toc-answer-2" class="nav-link" data-scroll-target="#answer-2">Answer</a></li>
  </ul></li>
  <li><a href="#more-details" id="toc-more-details" class="nav-link" data-scroll-target="#more-details">More Details</a>
  <ul class="collapse">
  <li><a href="#so-how-do-we-find-q-in-step-1" id="toc-so-how-do-we-find-q-in-step-1" class="nav-link" data-scroll-target="#so-how-do-we-find-q-in-step-1">So how do we find <span class="math inline">\(Q\)</span> (in step 1)?</a></li>
  <li><a href="#the-qr-decomposition" id="toc-the-qr-decomposition" class="nav-link" data-scroll-target="#the-qr-decomposition">The QR Decomposition</a></li>
  <li><a href="#how-should-we-choose-r" id="toc-how-should-we-choose-r" class="nav-link" data-scroll-target="#how-should-we-choose-r">How should we choose <span class="math inline">\(r\)</span>?</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#end" id="toc-end" class="nav-link" data-scroll-target="#end">End</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/xrsrke/computational-linear-algebra/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">2. Topic Modeling with NMF and SVD</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>You can read an overview of this Numerical Linear Algebra course in <a href="http://www.fast.ai/2017/07/17/num-lin-alg/">this blog post</a>. The course was originally taught in the <a href="https://www.usfca.edu/arts-sciences/graduate-programs/analytics">University of San Francisco MS in Analytics</a> graduate program. Course lecture videos are <a href="https://www.youtube.com/playlist?list=PLtmWHNX-gukIc92m1K0P6bIOnZb-mg0hY">available on YouTube</a> (note that the notebook numbers and video numbers do not line up, since some notebooks took longer than 1 video to cover).</p>
<p>You can ask questions about the course on <a href="http://forums.fast.ai/c/lin-alg">our fast.ai forums</a>.</p>
<p>Topic modeling is a great way to get started with matrix factorizations. We start with a <strong>term-document matrix</strong>:</p>
<p><img src="images/document_term.png" alt="term-document matrix" style="width: 80%"> (source: <a href="http://player.slideplayer.com/15/4528582/#">Introduction to Information Retrieval</a>)</p>
<p>We can decompose this into one tall thin matrix times one wide short matrix (possibly with a diagonal matrix in between).</p>
<p>Notice that this representation does not take into account word order or sentence structure. It’s an example of a <strong>bag of words</strong> approach.</p>
<section id="motivation" class="level3">
<h3 class="anchored" data-anchor-id="motivation">Motivation</h3>
<p>Consider the most extreme case - reconstructing the matrix using an outer product of two vectors. Clearly, in most cases we won’t be able to reconstruct the matrix exactly. But if we had one vector with the relative frequency of each vocabulary word out of the total word count, and one with the average number of words per document, then that outer product would be as close as we can get.</p>
<p>Now consider increasing that matrices to two columns and two rows. The optimal decomposition would now be to cluster the documents into two groups, each of which has as different a distribution of words as possible to each other, but as similar as possible amongst the documents in the cluster. We will call those two groups “topics”. And we would cluster the words into two groups, based on those which most frequently appear in each of the topics.</p>
</section>
<section id="in-todays-class" class="level3">
<h3 class="anchored" data-anchor-id="in-todays-class">In today’s class</h3>
<p>We’ll take a dataset of documents in several different categories, and find topics (consisting of groups of words) for them. Knowing the actual categories helps us evaluate if the topics we find make sense.</p>
<p>We will try this with two different matrix factorizations: <strong>Singular Value Decomposition (SVD)</strong> and <strong>Non-negative Matrix Factorization (NMF)</strong></p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> fetch_20newsgroups</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> decomposition</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> linalg</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<ul>
<li><a href="http://scikit-learn.org/stable/datasets/twenty_newsgroups.html">Data source</a>: Newsgroups are discussion groups on Usenet, which was popular in the 80s and 90s before the web really took off. This dataset includes 18,000 newsgroups posts with 20 topics.</li>
<li><a href="https://nlp.stanford.edu/IR-book/pdf/18lsi.pdf">Chris Manning’s book chapter</a> on matrix factorization and LSI</li>
<li>Scikit learn <a href="http://scikit-learn.org/stable/modules/decomposition.html#lsa">truncated SVD LSI details</a></li>
</ul>
<section id="other-tutorials" class="level3">
<h3 class="anchored" data-anchor-id="other-tutorials">Other Tutorials</h3>
<ul>
<li><a href="http://scikit-learn.org/stable/auto_examples/applications/plot_out_of_core_classification.html">Scikit-Learn: Out-of-core classification of text documents</a>: uses <a href="https://archive.ics.uci.edu/ml/datasets/reuters-21578+text+categorization+collection">Reuters-21578</a> dataset (Reuters articles labeled with ~100 categories), HashingVectorizer</li>
<li><a href="https://de.dariah.eu/tatom/index.html">Text Analysis with Topic Models for the Humanities and Social Sciences</a>: uses <a href="https://de.dariah.eu/tatom/datasets.html">British and French Literature dataset</a> of Jane Austen, Charlotte Bronte, Victor Hugo, and more</li>
</ul>
</section>
</section>
<section id="set-up-data" class="level2">
<h2 class="anchored" data-anchor-id="set-up-data">Set up data</h2>
<p>Scikit Learn comes with a number of built-in datasets, as well as loading utilities to load several standard external datasets. This is a <a href="http://scikit-learn.org/stable/datasets/">great resource</a>, and the datasets include Boston housing prices, face images, patches of forest, diabetes, breast cancer, and more. We will be using the newsgroups dataset.</p>
<p>Newsgroups are discussion groups on Usenet, which was popular in the 80s and 90s before the web really took off. This dataset includes 18,000 newsgroups posts with 20 topics.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>categories <span class="op">=</span> [<span class="st">'alt.atheism'</span>, <span class="st">'talk.religion.misc'</span>, <span class="st">'comp.graphics'</span>, <span class="st">'sci.space'</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>remove <span class="op">=</span> (<span class="st">'headers'</span>, <span class="st">'footers'</span>, <span class="st">'quotes'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>newsgroups_train <span class="op">=</span> fetch_20newsgroups(subset<span class="op">=</span><span class="st">'train'</span>, categories<span class="op">=</span>categories, remove<span class="op">=</span>remove)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>newsgroups_test <span class="op">=</span> fetch_20newsgroups(subset<span class="op">=</span><span class="st">'test'</span>, categories<span class="op">=</span>categories, remove<span class="op">=</span>remove)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>newsgroups_train.filenames.shape, newsgroups_train.target.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>((2034,), (2034,))</code></pre>
</div>
</div>
<p>Let’s look at some of the data. Can you guess which category these messages are in?</p>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(newsgroups_train.data[:<span class="dv">3</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hi,

I've noticed that if you only save a model (with all your mapping planes
positioned carefully) to a .3DS file that when you reload it after restarting
3DS, they are given a default position and orientation.  But if you save
to a .PRJ file their positions/orientation are preserved.  Does anyone
know why this information is not stored in the .3DS file?  Nothing is
explicitly said in the manual about saving texture rules in the .PRJ file. 
I'd like to be able to read the texture rule information, does anyone have 
the format for the .PRJ file?

Is the .CEL file format available from somewhere?

Rych


Seems to be, barring evidence to the contrary, that Koresh was simply
another deranged fanatic who thought it neccessary to take a whole bunch of
folks with him, children and all, to satisfy his delusional mania. Jim
Jones, circa 1993.


Nope - fruitcakes like Koresh have been demonstrating such evil corruption
for centuries.

 &gt;In article &lt;1993Apr19.020359.26996@sq.sq.com&gt;, msb@sq.sq.com (Mark Brader) 

MB&gt;                                                             So the
MB&gt; 1970 figure seems unlikely to actually be anything but a perijove.

JG&gt;Sorry, _perijoves_...I'm not used to talking this language.

Couldn't we just say periapsis or apoapsis?

 </code></pre>
</div>
</div>
<p>hint: definition of <em>perijove</em> is the point in the orbit of a satellite of Jupiter nearest the planet’s center</p>
<div class="cell" data-execution_count="249">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>np.array(newsgroups_train.target_names)[newsgroups_train.target[:<span class="dv">3</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="249">
<pre><code>array(['comp.graphics', 'talk.religion.misc', 'sci.space'], 
      dtype='&lt;U18')</code></pre>
</div>
</div>
<p>The target attribute is the integer index of the category.</p>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>newsgroups_train.target[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>array([1, 3, 2, 0, 2, 0, 2, 1, 2, 1])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>num_topics, num_top_words <span class="op">=</span> <span class="dv">6</span>, <span class="dv">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, scikit learn has a method that will extract all the word counts for us.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer, TfidfVectorizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="342">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>vectorizer <span class="op">=</span> CountVectorizer(stop_words<span class="op">=</span><span class="st">'english'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>vectors <span class="op">=</span> vectorizer.fit_transform(newsgroups_train.data).todense() <span class="co"># (documents, vocab)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>vectors.shape <span class="co">#, vectors.nnz / vectors.shape[0], row_means.shape</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="342">
<pre><code>(2034, 26576)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="343">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(newsgroups_train.data), vectors.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2034 (2034, 26576)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="303">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>vocab <span class="op">=</span> np.array(vectorizer.get_feature_names())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="304">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>vocab.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="304">
<pre><code>(26576,)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>vocab[<span class="dv">7000</span>:<span class="dv">7020</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array(['cosmonauts', 'cosmos', 'cosponsored', 'cost', 'costa', 'costar',
       'costing', 'costly', 'costruction', 'costs', 'cosy', 'cote',
       'couched', 'couldn', 'council', 'councils', 'counsel', 'counselees',
       'counselor', 'count'], 
      dtype='&lt;U80')</code></pre>
</div>
</div>
</section>
<section id="singular-value-decomposition-svd" class="level2">
<h2 class="anchored" data-anchor-id="singular-value-decomposition-svd">Singular Value Decomposition (SVD)</h2>
<p>“SVD is not nearly as famous as it should be.” - Gilbert Strang</p>
<p>We would clearly expect that the words that appear most frequently in one topic would appear less frequently in the other - otherwise that word wouldn’t make a good choice to separate out the two topics. Therefore, we expect the topics to be <strong>orthogonal</strong>.</p>
<p>The SVD algorithm factorizes a matrix into one matrix with <strong>orthogonal columns</strong> and one with <strong>orthogonal rows</strong> (along with a diagonal matrix, which contains the <strong>relative importance</strong> of each factor).</p>
<p><img src="images/svd_fb.png" alt="" style="width: 80%"> (source: <a href="https://research.fb.com/fast-randomized-svd/">Facebook Research: Fast Randomized SVD</a>)</p>
<p>SVD is an <strong>exact decomposition</strong>, since the matrices it creates are big enough to fully cover the original matrix. SVD is extremely widely used in linear algebra, and specifically in data science, including:</p>
<ul>
<li>semantic analysis</li>
<li>collaborative filtering/recommendations (<a href="https://datajobs.com/data-science-repo/Recommender-Systems-%5BNetflix%5D.pdf">winning entry for Netflix Prize</a>)</li>
<li>calculate Moore-Penrose pseudoinverse</li>
<li>data compression</li>
<li>principal component analysis (will be covered later in course)</li>
</ul>
<div class="cell" data-execution_count="344">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 27.2 s, sys: 812 ms, total: 28 s
Wall time: 27.9 s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="345">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(U.shape, s.shape, Vh.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(2034, 2034) (2034,) (2034, 26576)</code></pre>
</div>
</div>
<p>Confirm this is a decomposition of the input.</p>
<section id="answer" class="level4">
<h4 class="anchored" data-anchor-id="answer">Answer</h4>
<div class="cell" data-execution_count="346">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Exercise: confrim that U, s, Vh is a decomposition of the var Vectors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="346">
<pre><code>True</code></pre>
</div>
</div>
<p>Confirm that U, V are orthonormal</p>
</section>
<section id="answer-1" class="level4">
<h4 class="anchored" data-anchor-id="answer-1">Answer</h4>
<div class="cell" data-execution_count="246">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Exercise: Confirm that U, Vh are orthonormal</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="246">
<pre><code>True</code></pre>
</div>
</div>
</section>
<section id="topics" class="level4">
<h4 class="anchored" data-anchor-id="topics">Topics</h4>
<p>What can we say about the singular values s?</p>
<div class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>plt.plot(s)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2.%20Topic%20Modeling%20with%20NMF%20and%20SVD_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plt.plot(s[:<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2.%20Topic%20Modeling%20with%20NMF%20and%20SVD_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>num_top_words<span class="op">=</span><span class="dv">8</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_topics(a):</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    top_words <span class="op">=</span> <span class="kw">lambda</span> t: [vocab[i] <span class="cf">for</span> i <span class="kw">in</span> np.argsort(t)[:<span class="op">-</span>num_top_words<span class="op">-</span><span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    topic_words <span class="op">=</span> ([top_words(t) <span class="cf">for</span> t <span class="kw">in</span> a])</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="st">' '</span>.join(t) <span class="cf">for</span> t <span class="kw">in</span> topic_words]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="347">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>show_topics(Vh[:<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="347">
<pre><code>['critus ditto propagandist surname galacticentric kindergarten surreal imaginative',
 'jpeg gif file color quality image jfif format',
 'graphics edu pub mail 128 3d ray ftp',
 'jesus god matthew people atheists atheism does graphics',
 'image data processing analysis software available tools display',
 'god atheists atheism religious believe religion argument true',
 'space nasa lunar mars probe moon missions probes',
 'image probe surface lunar mars probes moon orbit',
 'argument fallacy conclusion example true ad argumentum premises',
 'space larson image theory universe physical nasa material']</code></pre>
</div>
</div>
<p>We get topics that match the kinds of clusters we would expect! This is despite the fact that this is an <strong>unsupervised algorithm</strong> - which is to say, we never actually told the algorithm how our documents are grouped.</p>
<p>We will return to SVD in <strong>much more detail</strong> later. For now, the important takeaway is that we have a tool that allows us to exactly factor a matrix into orthogonal columns and orthogonal rows.</p>
</section>
</section>
<section id="non-negative-matrix-factorization-nmf" class="level2">
<h2 class="anchored" data-anchor-id="non-negative-matrix-factorization-nmf">Non-negative Matrix Factorization (NMF)</h2>
<section id="motivation-1" class="level4">
<h4 class="anchored" data-anchor-id="motivation-1">Motivation</h4>
<p><img src="images/face_pca.png" alt="PCA on faces" style="width: 80%"></p>
<p>(source: <a href="http://perso.telecom-paristech.fr/~essid/teach/NMF_tutorial_ICME-2014.pdf">NMF Tutorial</a>)</p>
<p>A more interpretable approach:</p>
<p><img src="images/face_outputs.png" alt="NMF on Faces" style="width: 80%"></p>
<p>(source: <a href="http://perso.telecom-paristech.fr/~essid/teach/NMF_tutorial_ICME-2014.pdf">NMF Tutorial</a>)</p>
</section>
<section id="idea" class="level4">
<h4 class="anchored" data-anchor-id="idea">Idea</h4>
<p>Rather than constraining our factors to be <em>orthogonal</em>, another idea would to constrain them to be <em>non-negative</em>. NMF is a factorization of a non-negative data set <span class="math inline">\(V\)</span>: <span class="math display">\[ V = W H\]</span> into non-negative matrices <span class="math inline">\(W,\; H\)</span>. Often positive factors will be <strong>more easily interpretable</strong> (and this is the reason behind NMF’s popularity).</p>
<p><img src="images/face_nmf.png" alt="NMF on faces" style="width: 80%"></p>
<p>(source: <a href="http://perso.telecom-paristech.fr/~essid/teach/NMF_tutorial_ICME-2014.pdf">NMF Tutorial</a>)</p>
<p>Nonnegative matrix factorization (NMF) is a non-exact factorization that factors into one skinny positive matrix and one short positive matrix. NMF is NP-hard and non-unique. There are a number of variations on it, created by adding different constraints.</p>
</section>
<section id="applications-of-nmf" class="level4">
<h4 class="anchored" data-anchor-id="applications-of-nmf">Applications of NMF</h4>
<ul>
<li><a href="http://scikit-learn.org/stable/auto_examples/decomposition/plot_faces_decomposition.html#sphx-glr-auto-examples-decomposition-plot-faces-decomposition-py">Face Decompositions</a></li>
<li><a href="http://www.quuxlabs.com/blog/2010/09/matrix-factorization-a-simple-tutorial-and-implementation-in-python/">Collaborative Filtering, eg movie recommendations</a></li>
<li><a href="https://pdfs.semanticscholar.org/cc88/0b24791349df39c5d9b8c352911a0417df34.pdf">Audio source separation</a></li>
<li><a href="http://ieeexplore.ieee.org/document/1532909/">Chemistry</a></li>
<li><a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/s12859-015-0485-4">Bioinformatics</a> and <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2623306/">Gene Expression</a></li>
<li>Topic Modeling (our problem!)</li>
</ul>
<p><img src="images/nmf_doc.png" alt="NMF on documents" style="width: 80%"></p>
<p>(source: <a href="http://perso.telecom-paristech.fr/~essid/teach/NMF_tutorial_ICME-2014.pdf">NMF Tutorial</a>)</p>
<p><strong>More Reading</strong>:</p>
<ul>
<li><a href="https://arxiv.org/pdf/1401.5226.pdf">The Why and How of Nonnegative Matrix Factorization</a></li>
</ul>
</section>
<section id="nmf-from-sklearn" class="level3">
<h3 class="anchored" data-anchor-id="nmf-from-sklearn">NMF from sklearn</h3>
<p>First, we will use <a href="http://scikit-learn.org/stable/modules/generated/sklearn.decomposition.NMF.html">scikit-learn’s implementation of NMF</a>:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>m,n<span class="op">=</span>vectors.shape</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span><span class="dv">5</span>  <span class="co"># num topics</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="363">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>clf <span class="op">=</span> decomposition.NMF(n_components<span class="op">=</span>d, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>W1 <span class="op">=</span> clf.fit_transform(vectors)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>H1 <span class="op">=</span> clf.components_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="296">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>show_topics(H1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="296">
<pre><code>['jpeg image gif file color images format quality',
 'edu graphics pub mail 128 ray ftp send',
 'space launch satellite nasa commercial satellites year market',
 'jesus matthew prophecy people said messiah david isaiah',
 'image data available software processing ftp edu analysis',
 'god atheists atheism religious believe people religion does']</code></pre>
</div>
</div>
</section>
<section id="tf-idf" class="level3">
<h3 class="anchored" data-anchor-id="tf-idf">TF-IDF</h3>
<p><a href="http://www.tfidf.com/">Topic Frequency-Inverse Document Frequency</a> (TF-IDF) is a way to normalize term counts by taking into account how often they appear in a document, how long the document is, and how commmon/rare the term is.</p>
<p>TF = (# occurrences of term t in document) / (# of words in documents)</p>
<p>IDF = log(# of documents / # documents with term t in it)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>vectorizer_tfidf <span class="op">=</span> TfidfVectorizer(stop_words<span class="op">=</span><span class="st">'english'</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>vectors_tfidf <span class="op">=</span> vectorizer_tfidf.fit_transform(newsgroups_train.data) <span class="co"># (documents, vocab)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="263">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>W1 <span class="op">=</span> clf.fit_transform(vectors_tfidf)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>H1 <span class="op">=</span> clf.components_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="255">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>show_topics(H1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="255">
<pre><code>['don people just think like know say religion',
 'thanks graphics files image file program windows format',
 'space nasa launch shuttle orbit lunar moon earth',
 'ico bobbe tek beauchaine bronx manhattan sank queens',
 'god jesus bible believe atheism christian does belief',
 'objective morality values moral subjective science absolute claim']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>plt.plot(clf.components_[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2.%20Topic%20Modeling%20with%20NMF%20and%20SVD_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>clf.reconstruction_err_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>43.71292605795277</code></pre>
</div>
</div>
</section>
<section id="nmf-in-summary" class="level3">
<h3 class="anchored" data-anchor-id="nmf-in-summary">NMF in summary</h3>
<p>Benefits: Fast and easy to use!</p>
<p>Downsides: took years of research and expertise to create</p>
<p>Notes: - For NMF, matrix needs to be at least as tall as it is wide, or we get an error with fit_transform - Can use df_min in CountVectorizer to only look at words that were in at least k of the split texts</p>
</section>
<section id="nmf-from-scratch-in-numpy-using-sgd" class="level3">
<h3 class="anchored" data-anchor-id="nmf-from-scratch-in-numpy-using-sgd">NMF from scratch in numpy, using SGD</h3>
<section id="gradient-descent" class="level4">
<h4 class="anchored" data-anchor-id="gradient-descent">Gradient Descent</h4>
<p>The key idea of standard <strong>gradient descent</strong>: 1. Randomly choose some weights to start 2. Loop: - Use weights to calculate a prediction - Calculate the derivative of the loss - Update the weights 3. Repeat step 2 lots of times. Eventually we end up with some decent weights.</p>
<p><strong>Key</strong>: We want to decrease our loss and the derivative tells us the direction of <strong>steepest descent</strong>.</p>
<p>Note that <em>loss</em>, <em>error</em>, and <em>cost</em> are all terms used to describe the same thing.</p>
<p>Let’s take a look at the <a href="../fastai_nbs/gradient-descent-intro.html">Gradient Descent Intro notebook</a> (originally from the <a href="https://github.com/fastai/courses">fast.ai deep learning course</a>).</p>
</section>
<section id="stochastic-gradient-descent-sgd" class="level4">
<h4 class="anchored" data-anchor-id="stochastic-gradient-descent-sgd">Stochastic Gradient Descent (SGD)</h4>
<p><strong>Stochastic gradient descent</strong> is an incredibly useful optimization method (it is also the heart of deep learning, where it is used for backpropagation).</p>
<p>For <em>standard</em> gradient descent, we evaluate the loss using <strong>all</strong> of our data which can be really slow. In <em>stochastic</em> gradient descent, we evaluate our loss function on just a sample of our data (sometimes called a <em>mini-batch</em>). We would get different loss values on different samples of the data, so this is <em>why it is stochastic</em>. It turns out that this is still an effective way to optimize, and it’s much more efficient!</p>
<p>We can see how this works in this <a href="graddesc.xlsm">excel spreadsheet</a> (originally from the <a href="https://github.com/fastai/courses">fast.ai deep learning course</a>).</p>
<p><strong>Resources</strong>: - <a href="https://www.coursera.org/learn/machine-learning/lecture/DoRHJ/stochastic-gradient-descent">SGD Lecture from Andrew Ng’s Coursera ML course</a> - <a href="http://wiki.fast.ai/index.php/Stochastic_Gradient_Descent_(SGD)">fast.ai wiki page on SGD</a> - <a href="http://machinelearningmastery.com/gradient-descent-for-machine-learning/">Gradient Descent For Machine Learning</a> (Jason Brownlee- Machine Learning Mastery) - <a href="http://sebastianruder.com/optimizing-gradient-descent/">An overview of gradient descent optimization algorithms</a></p>
</section>
<section id="applying-sgd-to-nmf" class="level4">
<h4 class="anchored" data-anchor-id="applying-sgd-to-nmf">Applying SGD to NMF</h4>
<p><strong>Goal</strong>: Decompose <span class="math inline">\(V\;(m \times n)\)</span> into <span class="math display">\[V \approx WH\]</span> where <span class="math inline">\(W\;(m \times d)\)</span> and <span class="math inline">\(H\;(d \times n)\)</span>, <span class="math inline">\(W,\;H\;&gt;=\;0\)</span>, and we’ve minimized the Frobenius norm of <span class="math inline">\(V-WH\)</span>.</p>
<p><strong>Approach</strong>: We will pick random positive <span class="math inline">\(W\)</span> &amp; <span class="math inline">\(H\)</span>, and then use SGD to optimize.</p>
<p><strong>To use SGD, we need to know the gradient of the loss function.</strong></p>
<p><strong>Sources</strong>: - Optimality and gradients of NMF: http://users.wfu.edu/plemmons/papers/chu_ple.pdf - Projected gradients: https://www.csie.ntu.edu.tw/~cjlin/papers/pgradnmf.pdf</p>
<div class="cell" data-execution_count="272">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>lam<span class="op">=</span><span class="fl">1e3</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span><span class="fl">1e-2</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>m, n <span class="op">=</span> vectors_tfidf.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="252">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>W1 <span class="op">=</span> clf.fit_transform(vectors)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>H1 <span class="op">=</span> clf.components_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>show_topics(H1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="253">
<pre><code>['jpeg image gif file color images format quality',
 'edu graphics pub mail 128 ray ftp send',
 'space launch satellite nasa commercial satellites year market',
 'jesus matthew prophecy people said messiah david isaiah',
 'image data available software processing ftp edu analysis',
 'god atheists atheism religious believe people religion does']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="265">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grads(M, W, H):</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> W<span class="op">@</span>H<span class="op">-</span>M</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> R<span class="op">@</span>H.T <span class="op">+</span> penalty(W, mu)<span class="op">*</span>lam, W.T<span class="op">@</span>R <span class="op">+</span> penalty(H, mu)<span class="op">*</span>lam <span class="co"># dW, dH</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="266">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> penalty(M, mu):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.where(M<span class="op">&gt;=</span>mu,<span class="dv">0</span>, np.<span class="bu">min</span>(M <span class="op">-</span> mu, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="267">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> upd(M, W, H, lr):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    dW,dH <span class="op">=</span> grads(M,W,H)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    W <span class="op">-=</span> lr<span class="op">*</span>dW<span class="op">;</span> H <span class="op">-=</span> lr<span class="op">*</span>dH</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="268">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> report(M,W,H): </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(np.linalg.norm(M<span class="op">-</span>W<span class="op">@</span>H), W.<span class="bu">min</span>(), H.<span class="bu">min</span>(), (W<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">sum</span>(), (H<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="348">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> np.<span class="bu">abs</span>(np.random.normal(scale<span class="op">=</span><span class="fl">0.01</span>, size<span class="op">=</span>(m,d)))</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> np.<span class="bu">abs</span>(np.random.normal(scale<span class="op">=</span><span class="fl">0.01</span>, size<span class="op">=</span>(d,n)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="349">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>report(vectors_tfidf, W, H)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>44.4395133509 5.67503308167e-07 2.49717354504e-07 0 0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="350">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>upd(vectors_tfidf,W,H,lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="351">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>report(vectors_tfidf, W, H)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>44.4194155587 -0.00186845669883 -0.000182969569359 509 788</code></pre>
</div>
</div>
<div class="cell" data-execution_count="352">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">50</span>): </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    upd(vectors_tfidf,W,H,lr)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>: report(vectors_tfidf,W,H)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>44.4071645597 -0.00145791197281 -0.00012862260312 343 1174
44.352156176 -0.000549676823494 -9.16363641124e-05 218 4689
44.3020593384 -0.000284017335617 -0.000130903875061 165 9685
44.2468609535 -0.000279317810433 -0.000182173029912 169 16735
44.199218 -0.000290092649623 -0.000198140867356 222 25109</code></pre>
</div>
</div>
<div class="cell" data-execution_count="281">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>show_topics(H)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="281">
<pre><code>['cview file image edu files use directory temp',
 'moral like time does don software new years',
 'god jesus bible believe objective exist atheism belief',
 'thanks graphics program know help looking windows advance',
 'space nasa launch shuttle orbit station moon lunar',
 'people don said think ico tek bobbe bronx']</code></pre>
</div>
</div>
<p>This is painfully slow to train! Lots of parameter fiddling and still slow to train (or explodes).</p>
</section>
</section>
<section id="pytorch" class="level3">
<h3 class="anchored" data-anchor-id="pytorch">PyTorch</h3>
<p><a href="http://pytorch.org/">PyTorch</a> is a Python framework for tensors and dynamic neural networks with GPU acceleration. Many of the core contributors work on Facebook’s AI team. In many ways, it is similar to Numpy, only with the increased parallelization of using a GPU.</p>
<p>From the <a href="http://pytorch.org/tutorials/beginner/blitz/tensor_tutorial.html">PyTorch documentation</a>:</p>
<p><img src="images/what_is_pytorch.png" alt="pytorch" style="width: 80%"></p>
<p><strong>Further learning</strong>: If you are curious to learn what <em>dynamic</em> neural networks are, you may want to watch <a href="https://www.youtube.com/watch?v=Z15cBAuY7Sc">this talk</a> by Soumith Chintala, Facebook AI researcher and core PyTorch contributor.</p>
<p>If you want to learn more PyTorch, you can try this <a href="http://pytorch.org/tutorials/beginner/deep_learning_60min_blitz.html">tutorial</a> or this <a href="http://pytorch.org/tutorials/beginner/pytorch_with_examples.html">learning by examples</a>.</p>
<p><strong>Note about GPUs</strong>: If you are not using a GPU, you will need to remove the <code>.cuda()</code> from the methods below. GPU usage is not required for this course, but I thought it would be of interest to some of you. To learn how to create an AWS instance with a GPU, you can watch the <a href="http://course.fast.ai/lessons/aws.html">fast.ai setup lesson</a>.</p>
<div class="cell" data-execution_count="282">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.cuda <span class="im">as</span> tc</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.autograd <span class="im">import</span> Variable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="283">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> V(M): <span class="cf">return</span> Variable(M, requires_grad<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="284">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>v<span class="op">=</span>vectors_tfidf.todense()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="285">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>t_vectors <span class="op">=</span> torch.Tensor(v.astype(np.float32)).cuda()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="286">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> <span class="fl">1e-5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="287">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grads_t(M, W, H):</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> W.mm(H)<span class="op">-</span>M</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (R.mm(H.t()) <span class="op">+</span> penalty_t(W, mu)<span class="op">*</span>lam, </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        W.t().mm(R) <span class="op">+</span> penalty_t(H, mu)<span class="op">*</span>lam) <span class="co"># dW, dH</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> penalty_t(M, mu):</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (M<span class="op">&lt;</span>mu).<span class="bu">type</span>(tc.FloatTensor)<span class="op">*</span>torch.clamp(M <span class="op">-</span> mu, <span class="bu">max</span><span class="op">=</span><span class="fl">0.</span>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> upd_t(M, W, H, lr):</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    dW,dH <span class="op">=</span> grads_t(M,W,H)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    W.sub_(lr<span class="op">*</span>dW)<span class="op">;</span> H.sub_(lr<span class="op">*</span>dH)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> report_t(M,W,H): </span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>((M<span class="op">-</span>W.mm(H)).norm(<span class="dv">2</span>), W.<span class="bu">min</span>(), H.<span class="bu">min</span>(), (W<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">sum</span>(), (H<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">sum</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="354">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>t_W <span class="op">=</span> tc.FloatTensor(m,d)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>t_H <span class="op">=</span> tc.FloatTensor(d,n)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>t_W.normal_(std<span class="op">=</span><span class="fl">0.01</span>).abs_()<span class="op">;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>t_H.normal_(std<span class="op">=</span><span class="fl">0.01</span>).abs_()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="355">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>d<span class="op">=</span><span class="dv">6</span><span class="op">;</span> lam<span class="op">=</span><span class="dv">100</span><span class="op">;</span> lr<span class="op">=</span><span class="fl">0.05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="356">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>): </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    upd_t(t_vectors,t_W,t_H,lr)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">0</span>: </span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>        report_t(t_vectors,t_W,t_H)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">*=</span> <span class="fl">0.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>44.392791748046875 -0.0060190423391759396 -0.0004986411076970398 1505 2282
43.746803283691406 -0.009054708294570446 -0.011047963984310627 2085 23854
43.702056884765625 -0.008214150555431843 -0.014783496037125587 2295 24432
43.654273986816406 -0.006195350084453821 -0.006913348101079464 2625 22663
43.646759033203125 -0.004638500511646271 -0.003197424579411745 2684 23270
43.645320892333984 -0.005679543130099773 -0.00419645756483078 3242 24199
43.6449089050293 -0.0041352929547429085 -0.00843129213899374 3282 25030
43.64469528198242 -0.003943094052374363 -0.00745873199775815 3129 26220
43.64459991455078 -0.004347225651144981 -0.007400824688374996 3031 26323
43.64434051513672 -0.0039044099394232035 -0.0067480215802788734 3930 33718</code></pre>
</div>
</div>
<div class="cell" data-execution_count="291">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>show_topics(t_H.cpu().numpy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="291">
<pre><code>['objective morality values moral subjective science absolute claim',
 'god jesus bible believe atheism christian does belief',
 'ico bobbe tek bronx beauchaine manhattan sank queens',
 'thanks graphics files image file program windows know',
 'space nasa launch shuttle orbit lunar moon earth',
 'don people just think like know say religion']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="292">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>plt.plot(t_H.cpu().numpy()[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2.%20Topic%20Modeling%20with%20NMF%20and%20SVD_files/figure-html/cell-55-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="1328">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>t_W.mm(t_H).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1328">
<pre><code>0.43389660120010376</code></pre>
</div>
</div>
<div class="cell" data-execution_count="1329">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>t_vectors.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1329">
<pre><code>0.9188119769096375</code></pre>
</div>
</div>
</section>
<section id="pytorch-autograd" class="level3">
<h3 class="anchored" data-anchor-id="pytorch-autograd">PyTorch: autograd</h3>
<p>Above, we used our knowledge of what the gradient of the loss function was to do SGD from scratch in PyTorch. However, PyTorch has an automatic differentiation package, <a href="http://pytorch.org/docs/autograd.html">autograd</a> which we could use instead. This is really useful, in that we can use autograd on problems where we don’t know what the derivative is.</p>
<p>The approach we use below is very general, and would work for almost any optimization problem.</p>
<p>In PyTorch, Variables have the same API as tensors, but Variables remember the operations used on to create them. This lets us take derivatives.</p>
<section id="pytorch-autograd-introduction" class="level4">
<h4 class="anchored" data-anchor-id="pytorch-autograd-introduction">PyTorch Autograd Introduction</h4>
<p>Example taken from <a href="http://pytorch.org/tutorials/beginner/former_torchies/autograd_tutorial.html">this tutorial</a> in the official documentation.</p>
<div class="cell" data-execution_count="375">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> Variable(torch.ones(<span class="dv">2</span>, <span class="dv">2</span>), requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variable containing:
 1  1
 1  1
[torch.FloatTensor of size 2x2]
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="376">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x.data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 1  1
 1  1
[torch.FloatTensor of size 2x2]
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="377">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x.grad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variable containing:
 0  0
 0  0
[torch.FloatTensor of size 2x2]
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="378">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> x <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variable containing:
 3  3
 3  3
[torch.FloatTensor of size 2x2]
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="383">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> y <span class="op">*</span> y <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> z.<span class="bu">sum</span>()</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(z, out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variable containing:
 27  27
 27  27
[torch.FloatTensor of size 2x2]
 Variable containing:
 108
[torch.FloatTensor of size 1]
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="382">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>out.backward()</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(x.grad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variable containing:
 18  18
 18  18
[torch.FloatTensor of size 2x2]
</code></pre>
</div>
</div>
</section>
<section id="using-autograd-for-nmf" class="level4">
<h4 class="anchored" data-anchor-id="using-autograd-for-nmf">Using Autograd for NMF</h4>
<div class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>lam<span class="op">=</span><span class="fl">1e6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>pW <span class="op">=</span> Variable(tc.FloatTensor(m,d), requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>pH <span class="op">=</span> Variable(tc.FloatTensor(d,n), requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>pW.data.normal_(std<span class="op">=</span><span class="fl">0.01</span>).abs_()</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>pH.data.normal_(std<span class="op">=</span><span class="fl">0.01</span>).abs_()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="357">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> report():</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    W,H <span class="op">=</span> pW.data, pH.data</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>((M<span class="op">-</span>pW.mm(pH)).norm(<span class="dv">2</span>).data[<span class="dv">0</span>], W.<span class="bu">min</span>(), H.<span class="bu">min</span>(), (W<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">sum</span>(), (H<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">sum</span>())</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> penalty(A):</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.<span class="bu">pow</span>((A<span class="op">&lt;</span><span class="dv">0</span>).<span class="bu">type</span>(tc.FloatTensor)<span class="op">*</span>torch.clamp(A, <span class="bu">max</span><span class="op">=</span><span class="fl">0.</span>), <span class="dv">2</span>)</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> penalize(): <span class="cf">return</span> penalty(pW).mean() <span class="op">+</span> penalty(pH).mean()</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loss(): <span class="cf">return</span> (M<span class="op">-</span>pW.mm(pH)).norm(<span class="dv">2</span>) <span class="op">+</span> penalize()<span class="op">*</span>lam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="358">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> Variable(t_vectors).cuda()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="359">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> torch.optim.Adam([pW,pH], lr<span class="op">=</span><span class="fl">1e-3</span>, betas<span class="op">=</span>(<span class="fl">0.9</span>,<span class="fl">0.9</span>))</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>report()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>43.66044616699219 -0.0002547535696066916 -0.00046720390673726797 319 8633</code></pre>
</div>
</div>
<p>How to apply SGD, using autograd:</p>
<div class="cell" data-scrolled="true" data-execution_count="361">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>): </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    opt.zero_grad()</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    l <span class="op">=</span> loss()</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    l.backward()</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    opt.step()</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">%</span> <span class="dv">100</span> <span class="op">==</span> <span class="dv">99</span>: </span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>        report()</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">*=</span> <span class="fl">0.9</span>     <span class="co"># learning rate annealling</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>43.628597259521484 -0.022899555042386055 -0.26526615023612976 692 82579
43.62860107421875 -0.021287493407726288 -0.2440912425518036 617 77552
43.628597259521484 -0.020111067220568657 -0.22828206419944763 576 77726
43.628604888916016 -0.01912039890885353 -0.21654289960861206 553 84411
43.62861251831055 -0.018248897045850754 -0.20736189186573029 544 75546
43.62862014770508 -0.01753264293074608 -0.19999365508556366 491 78949
43.62862777709961 -0.016773322597146034 -0.194113627076149 513 83822
43.628639221191406 -0.01622121036052704 -0.18905577063560486 485 74101
43.62863540649414 -0.01574397087097168 -0.18498440086841583 478 85987
43.628639221191406 -0.015293922275304794 -0.18137598037719727 487 74023</code></pre>
</div>
</div>
<div class="cell" data-execution_count="362">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> pH.data.cpu().numpy()</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>show_topics(h)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="362">
<pre><code>['god jesus bible believe atheism christian belief does',
 'thanks graphics files image file windows program format',
 'just don think people like ve graphics religion',
 'objective morality values moral subjective science absolute claim',
 'ico bobbe tek beauchaine bronx manhattan sank queens',
 'space nasa shuttle launch orbit lunar moon data']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>plt.plot(h[<span class="dv">0</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2.%20Topic%20Modeling%20with%20NMF%20and%20SVD_files/figure-html/cell-72-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="comparing-approaches" class="level3">
<h3 class="anchored" data-anchor-id="comparing-approaches">Comparing Approaches</h3>
<section id="scikit-learns-nmf" class="level4">
<h4 class="anchored" data-anchor-id="scikit-learns-nmf">Scikit-Learn’s NMF</h4>
<ul>
<li>Fast</li>
<li>No parameter tuning</li>
<li>Relies on decades of academic research, took experts a long time to implement</li>
</ul>
<p><img src="images/nimfa.png" alt="research on NMF" style="width: 80%"> source: <a href="http://nimfa.biolab.si/">Python Nimfa Documentation</a></p>
</section>
<section id="using-pytorch-and-sgd" class="level4">
<h4 class="anchored" data-anchor-id="using-pytorch-and-sgd">Using PyTorch and SGD</h4>
<ul>
<li>Took us an hour to implement, didn’t have to be NMF experts</li>
<li>Parameters were fiddly</li>
<li>Not as fast (tried in numpy and was so slow we had to switch to PyTorch)</li>
</ul>
</section>
</section>
</section>
<section id="truncated-svd" class="level2">
<h2 class="anchored" data-anchor-id="truncated-svd">Truncated SVD</h2>
<p>We saved a lot of time when we calculated NMF by only calculating the subset of columns we were interested in. Is there a way to get this benefit with SVD? Yes there is! It’s called truncated SVD. We are just interested in the vectors corresponding to the <strong>largest</strong> singular values.</p>
<p><img src="images/svd_fb.png" alt="" style="width: 80%"> (source: <a href="https://research.fb.com/fast-randomized-svd/">Facebook Research: Fast Randomized SVD</a>)</p>
<section id="shortcomings-of-classical-algorithms-for-decomposition" class="level4">
<h4 class="anchored" data-anchor-id="shortcomings-of-classical-algorithms-for-decomposition">Shortcomings of classical algorithms for decomposition:</h4>
<ul>
<li>Matrices are “stupendously big”</li>
<li>Data are often <strong>missing or inaccurate</strong>. Why spend extra computational resources when imprecision of input limits precision of the output?</li>
<li><strong>Data transfer</strong> now plays a major role in time of algorithms. Techniques the require fewer passes over the data may be substantially faster, even if they require more flops (flops = floating point operations).</li>
<li>Important to take advantage of <strong>GPUs</strong>.</li>
</ul>
<p>(source: <a href="https://arxiv.org/abs/0909.4061">Halko</a>)</p>
</section>
<section id="advantages-of-randomized-algorithms" class="level4">
<h4 class="anchored" data-anchor-id="advantages-of-randomized-algorithms">Advantages of randomized algorithms:</h4>
<ul>
<li>inherently stable</li>
<li>performance guarantees do not depend on subtle spectral properties</li>
<li>needed matrix-vector products can be done in parallel</li>
</ul>
<p>(source: <a href="https://arxiv.org/abs/0909.4061">Halko</a>)</p>
</section>
<section id="randomized-svd" class="level3">
<h3 class="anchored" data-anchor-id="randomized-svd">Randomized SVD</h3>
<p>Reminder: full SVD is <strong>slow</strong>. This is the calculation we did above using Scipy’s Linalg SVD:</p>
<div class="cell" data-execution_count="384">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>vectors.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="384">
<pre><code>(2034, 26576)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="344">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 27.2 s, sys: 812 ms, total: 28 s
Wall time: 27.9 s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="345">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(U.shape, s.shape, Vh.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(2034, 2034) (2034,) (2034, 26576)</code></pre>
</div>
</div>
<p>Fortunately, there is a faster way:</p>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 144 ms, sys: 8 ms, total: 152 ms
Wall time: 154 ms</code></pre>
</div>
</div>
<p>The runtime complexity for SVD is <span class="math inline">\(\mathcal{O}(\text{min}(m^2 n,\; m n^2))\)</span></p>
<p><strong>Question</strong>: How can we speed things up? (without new breakthroughs in SVD research)</p>
<p><strong>Idea</strong>: Let’s use a smaller matrix (with smaller <span class="math inline">\(n\)</span>)!</p>
<p>Instead of calculating the SVD on our full matrix <span class="math inline">\(A\)</span> which is <span class="math inline">\(m \times n\)</span>, let’s use <span class="math inline">\(B = A Q\)</span>, which is just <span class="math inline">\(m \times r\)</span> and <span class="math inline">\(r &lt;&lt; n\)</span></p>
<p>We haven’t found a better general SVD method, we are just using the method we have on a smaller matrix.</p>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 144 ms, sys: 8 ms, total: 152 ms
Wall time: 154 ms</code></pre>
</div>
</div>
<div class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>u.shape, s.shape, v.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre><code>((2034, 5), (5,), (5, 26576))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>show_topics(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="178">
<pre><code>['jpeg image edu file graphics images gif data',
 'jpeg gif file color quality image jfif format',
 'space jesus launch god people satellite matthew atheists',
 'jesus god matthew people atheists atheism does graphics',
 'image data processing analysis software available tools display']</code></pre>
</div>
</div>
<p>Here are some results from <a href="https://research.fb.com/fast-randomized-svd/">Facebook Research</a>:</p>
<p><img src="images/randomizedSVDbenchmarks.png" alt="" style="width: 80%"></p>
<p><strong>Johnson-Lindenstrauss Lemma</strong>: (<a href="https://en.wikipedia.org/wiki/Johnson%E2%80%93Lindenstrauss_lemma">from wikipedia</a>) a small set of points in a high-dimensional space can be embedded into a space of much lower dimension in such a way that distances between the points are nearly preserved.</p>
<p>It is desirable to be able to reduce dimensionality of data in a way that preserves relevant structure. The Johnson–Lindenstrauss lemma is a classic result of this type.</p>
</section>
<section id="implementing-our-own-randomized-svd" class="level3">
<h3 class="anchored" data-anchor-id="implementing-our-own-randomized-svd">Implementing our own Randomized SVD</h3>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> linalg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The method <code>randomized_range_finder</code> finds an orthonormal matrix whose range approximates the range of A (step 1 in our algorithm above). To do so, we use the LU and QR factorizations, both of which we will be covering in depth later.</p>
<p>I am using the <a href="https://github.com/scikit-learn/scikit-learn/blob/14031f65d144e3966113d3daec836e443c6d7a5b/sklearn/utils/extmath.py">scikit-learn.extmath.randomized_svd source code</a> as a guide.</p>
<div class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># computes an orthonormal matrix whose range approximates the range of A</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co"># power_iteration_normalizer can be safe_sparse_dot (fast but unstable), LU (imbetween), or QR (slow but most accurate)</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> randomized_range_finder(A, size, n_iter<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> np.random.normal(size<span class="op">=</span>(A.shape[<span class="dv">1</span>], size))</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_iter):</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>        Q, _ <span class="op">=</span> linalg.lu(A <span class="op">@</span> Q, permute_l<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>        Q, _ <span class="op">=</span> linalg.lu(A.T <span class="op">@</span> Q, permute_l<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    Q, _ <span class="op">=</span> linalg.qr(A <span class="op">@</span> Q, mode<span class="op">=</span><span class="st">'economic'</span>)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here’s our randomized SVD method:</p>
<div class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> randomized_svd(M, n_components, n_oversamples<span class="op">=</span><span class="dv">10</span>, n_iter<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    n_random <span class="op">=</span> n_components <span class="op">+</span> n_oversamples</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> randomized_range_finder(M, n_random, n_iter)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># project M to the (k + p) dimensional space using the basis vectors</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> Q.T <span class="op">@</span> M</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute the SVD on the thin matrix: (k + p) wide</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    Uhat, s, V <span class="op">=</span> linalg.svd(B, full_matrices<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> B</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> Q <span class="op">@</span> Uhat</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U[:, :n_components], s[:n_components], V[:n_components, :]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>u, s, v <span class="op">=</span> randomized_svd(vectors, <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 136 ms, sys: 0 ns, total: 136 ms
Wall time: 137 ms</code></pre>
</div>
</div>
<div class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>u.shape, s.shape, v.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="239">
<pre><code>((2034, 5), (5,), (5, 26576))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="247">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>show_topics(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="247">
<pre><code>['jpeg image edu file graphics images gif data',
 'edu graphics data space pub mail 128 3d',
 'space jesus launch god people satellite matthew atheists',
 'space launch satellite commercial nasa satellites market year',
 'image data processing analysis software available tools display']</code></pre>
</div>
</div>
<p>Write a loop to calculate the error of your decomposition as you vary the # of topics. Plot the result</p>
<section id="answer-2" class="level4">
<h4 class="anchored" data-anchor-id="answer-2">Answer</h4>
<div class="cell" data-execution_count="248">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Exercise: Write a loop to calculate the error of your decomposition as you vary the # of topics</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="242">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(<span class="dv">0</span>,n<span class="op">*</span>step,step), error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2.%20Topic%20Modeling%20with%20NMF%20and%20SVD_files/figure-html/cell-88-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><strong>Further Resources</strong>: - <a href="http://www.cs.ubc.ca/~nickhar/W12/">a whole course on randomized algorithms</a></p>
</section>
</section>
<section id="more-details" class="level3">
<h3 class="anchored" data-anchor-id="more-details">More Details</h3>
<p>Here is a process to calculate a truncated SVD, described in <a href="https://arxiv.org/pdf/0909.4061.pdf">Finding Structure with Randomness: Probabilistic Algorithms for Constructing Approximate Matrix Decompositions</a> and <a href="https://research.fb.com/fast-randomized-svd/">summarized in this blog post</a>:</p>
<p>1. Compute an approximation to the range of <span class="math inline">\(A\)</span>. That is, we want <span class="math inline">\(Q\)</span> with <span class="math inline">\(r\)</span> orthonormal columns such that <span class="math display">\[A \approx QQ^TA\]</span></p>
<p>2. Construct <span class="math inline">\(B = Q^T A\)</span>, which is small (<span class="math inline">\(r\times n\)</span>)</p>
<p>3. Compute the SVD of <span class="math inline">\(B\)</span> by standard methods (fast since <span class="math inline">\(B\)</span> is smaller than <span class="math inline">\(A\)</span>), <span class="math inline">\(B = S\,\Sigma V^T\)</span></p>
<p>4. Since <span class="math display">\[ A \approx Q Q^T A = Q (S\,\Sigma V^T)\]</span> if we set <span class="math inline">\(U = QS\)</span>, then we have a low rank approximation <span class="math inline">\(A \approx U \Sigma V^T\)</span>.</p>
<section id="so-how-do-we-find-q-in-step-1" class="level4">
<h4 class="anchored" data-anchor-id="so-how-do-we-find-q-in-step-1">So how do we find <span class="math inline">\(Q\)</span> (in step 1)?</h4>
<p>To estimate the range of <span class="math inline">\(A\)</span>, we can just take a bunch of random vectors <span class="math inline">\(w_i\)</span>, evaluate the subspace formed by <span class="math inline">\(Aw_i\)</span>. We can form a matrix <span class="math inline">\(W\)</span> with the <span class="math inline">\(w_i\)</span> as it’s columns. Now, we take the QR decomposition of <span class="math inline">\(AW = QR\)</span>, then the columns of <span class="math inline">\(Q\)</span> form an orthonormal basis for <span class="math inline">\(AW\)</span>, which is the range of <span class="math inline">\(A\)</span>.</p>
<p>Since the matrix <span class="math inline">\(AW\)</span> of the product has far more rows than columns and therefore, approximately, orthonormal columns. This is simple probability - with lots of rows, and few columns, it’s unlikely that the columns are linearly dependent.</p>
</section>
<section id="the-qr-decomposition" class="level4">
<h4 class="anchored" data-anchor-id="the-qr-decomposition">The QR Decomposition</h4>
<p>We will be learning about the QR decomposition <strong>in depth</strong> later on. For now, you just need to know that <span class="math inline">\(A = QR\)</span>, where <span class="math inline">\(Q\)</span> consists of orthonormal columns, and <span class="math inline">\(R\)</span> is upper triangular. Trefethen says that the QR decomposition is the most important idea in numerical linear algebra! We will definitely be returning to it.</p>
</section>
<section id="how-should-we-choose-r" class="level4">
<h4 class="anchored" data-anchor-id="how-should-we-choose-r">How should we choose <span class="math inline">\(r\)</span>?</h4>
<p>Suppose our matrix has 100 columns, and we want 5 columns in U and V. To be safe, we should project our matrix onto an orthogonal basis with a few more rows and columns than 5 (let’s use 15). At the end, we will just grab the first 5 columns of U and V</p>
<p>So even although our projection was only approximate, by making it a bit bigger than we need, we can make up for the loss of accuracy (since we’re only taking a subset later).</p>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 144 ms, sys: 8 ms, total: 152 ms
Wall time: 154 ms</code></pre>
</div>
</div>
<div class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.38 s, sys: 592 ms, total: 2.97 s
Wall time: 2.96 s</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="end" class="level2">
<h2 class="anchored" data-anchor-id="end">End</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>