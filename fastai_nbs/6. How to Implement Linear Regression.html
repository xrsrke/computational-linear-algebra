<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.75">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>computational-linear-algebra - 6. How to Implement Linear Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: 1;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="computational-linear-algebra - 6. How to Implement Linear Regression">
<meta property="og:description" content="You can read an overview of this Numerical Linear Algebra course in this blog post. The course was originally taught in the University of San Francisco MS in Analytics graduate program.">
<meta property="og:site-name" content="computational-linear-algebra">
<meta name="twitter:title" content="computational-linear-algebra - 6. How to Implement Linear Regression">
<meta name="twitter:description" content="You can read an overview of this Numerical Linear Algebra course in this blog post. The course was originally taught in the University of San Francisco MS in Analytics graduate program.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">computational-linear-algebra</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/xrsrke/computational-linear-algebra"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">6. How to Implement Linear Regression</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">computational-linear-algebra</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core.html" class="sidebar-item-text sidebar-link">core</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_matrix_math_accuracy_memory_speed_parallelization.html" class="sidebar-item-text sidebar-link">1. Matrix Math, Accuracy, Memory, Speed, &amp; Parallelization</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">fastai_nbs</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/0. Course Logistics.html" class="sidebar-item-text sidebar-link">0. Course Logistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/1. Why are we here.html" class="sidebar-item-text sidebar-link">1. Why are we here?</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/2. Topic Modeling with NMF and SVD.html" class="sidebar-item-text sidebar-link">2. Topic Modeling with NMF and SVD</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/3. Background Removal with Robust PCA.html" class="sidebar-item-text sidebar-link">3. Background Removal with Robust PCA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/4. Compressed Sensing of CT Scans with Robust Regression.html" class="sidebar-item-text sidebar-link">4. Compressed Sensing of CT Scans with Robust Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/5. Health Outcomes with Linear Regression.html" class="sidebar-item-text sidebar-link">5. Health Outcomes with Linear Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/6. How to Implement Linear Regression.html" class="sidebar-item-text sidebar-link active">6. How to Implement Linear Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/7. PageRank with Eigen Decompositions.html" class="sidebar-item-text sidebar-link">7. PageRank with Eigen Decompositions</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/8. Implementing QR Factorization.html" class="sidebar-item-text sidebar-link">8. Implementing QR Factorization</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/Homework 1.html" class="sidebar-item-text sidebar-link">Homework 1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/Homework 2.html" class="sidebar-item-text sidebar-link">Homework 2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/Homework 3.html" class="sidebar-item-text sidebar-link">Homework 3</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/convolution-intro.html" class="sidebar-item-text sidebar-link">Intro to Convolutions</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../fastai_nbs/gradient-descent-intro.html" class="sidebar-item-text sidebar-link">Gradient Descent Intro</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#how-did-sklearn-do-it" id="toc-how-did-sklearn-do-it" class="nav-link active" data-scroll-target="#how-did-sklearn-do-it">How did sklearn do it?</a>
  <ul>
  <li><a href="#scipy-sparse-least-squares" id="toc-scipy-sparse-least-squares" class="nav-link" data-scroll-target="#scipy-sparse-least-squares">Scipy Sparse Least Squares</a></li>
  </ul></li>
  <li><a href="#linalg.lstqr" id="toc-linalg.lstqr" class="nav-link" data-scroll-target="#linalg.lstqr">linalg.lstqr</a></li>
  <li><a href="#naive-solution" id="toc-naive-solution" class="nav-link" data-scroll-target="#naive-solution">Naive Solution</a></li>
  <li><a href="#normal-equations-cholesky" id="toc-normal-equations-cholesky" class="nav-link" data-scroll-target="#normal-equations-cholesky">Normal Equations (Cholesky)</a></li>
  <li><a href="#qr-factorization" id="toc-qr-factorization" class="nav-link" data-scroll-target="#qr-factorization">QR Factorization</a></li>
  <li><a href="#svd" id="toc-svd" class="nav-link" data-scroll-target="#svd">SVD</a></li>
  <li><a href="#random-sketching-technique-for-least-squares-regression" id="toc-random-sketching-technique-for-least-squares-regression" class="nav-link" data-scroll-target="#random-sketching-technique-for-least-squares-regression">Random Sketching Technique for Least Squares Regression</a></li>
  <li><a href="#timing-comparison" id="toc-timing-comparison" class="nav-link" data-scroll-target="#timing-comparison">Timing Comparison</a></li>
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a></li>
  <li><a href="#conditioning-stability" id="toc-conditioning-stability" class="nav-link" data-scroll-target="#conditioning-stability">Conditioning &amp; stability</a>
  <ul>
  <li><a href="#condition-number" id="toc-condition-number" class="nav-link" data-scroll-target="#condition-number">Condition Number</a></li>
  <li><a href="#conditioning-example" id="toc-conditioning-example" class="nav-link" data-scroll-target="#conditioning-example">Conditioning example</a></li>
  <li><a href="#condition-number-of-a-matrix" id="toc-condition-number-of-a-matrix" class="nav-link" data-scroll-target="#condition-number-of-a-matrix">Condition Number of a Matrix</a></li>
  </ul></li>
  <li><a href="#loose-ends-from-last-time" id="toc-loose-ends-from-last-time" class="nav-link" data-scroll-target="#loose-ends-from-last-time">Loose ends from last time</a>
  <ul>
  <li><a href="#full-vs-reduced-factorizations" id="toc-full-vs-reduced-factorizations" class="nav-link" data-scroll-target="#full-vs-reduced-factorizations">Full vs Reduced Factorizations</a></li>
  <li><a href="#matrix-inversion-is-unstable" id="toc-matrix-inversion-is-unstable" class="nav-link" data-scroll-target="#matrix-inversion-is-unstable">Matrix Inversion is Unstable</a>
  <ul class="collapse">
  <li><a href="#svd-is-best-here" id="toc-svd-is-best-here" class="nav-link" data-scroll-target="#svd-is-best-here">SVD is best here!</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#runtime" id="toc-runtime" class="nav-link" data-scroll-target="#runtime">Runtime</a>
  <ul>
  <li><a href="#a-case-where-qr-is-the-best" id="toc-a-case-where-qr-is-the-best" class="nav-link" data-scroll-target="#a-case-where-qr-is-the-best">A Case Where QR is the Best</a></li>
  <li><a href="#low-rank" id="toc-low-rank" class="nav-link" data-scroll-target="#low-rank">Low-rank</a></li>
  </ul></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/xrsrke/computational-linear-algebra/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">6. How to Implement Linear Regression</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>You can read an overview of this Numerical Linear Algebra course in <a href="http://www.fast.ai/2017/07/17/num-lin-alg/">this blog post</a>. The course was originally taught in the <a href="https://www.usfca.edu/arts-sciences/graduate-programs/analytics">University of San Francisco MS in Analytics</a> graduate program. Course lecture videos are <a href="https://www.youtube.com/playlist?list=PLtmWHNX-gukIc92m1K0P6bIOnZb-mg0hY">available on YouTube</a> (note that the notebook numbers and video numbers do not line up, since some notebooks took longer than 1 video to cover).</p>
<p>You can ask questions about the course on <a href="http://forums.fast.ai/c/lin-alg">our fast.ai forums</a>.</p>
<p>In the previous lesson, we calculated the least squares linear regression for a diabetes dataset, using scikit learn’s implementation. Today, we will look at how we could write our own implementation.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> datasets, linear_model, metrics</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> PolynomialFeatures</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math, scipy, numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> linalg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(precision<span class="op">=</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> datasets.load_diabetes()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>feature_names<span class="op">=</span>[<span class="st">'age'</span>, <span class="st">'sex'</span>, <span class="st">'bmi'</span>, <span class="st">'bp'</span>, <span class="st">'s1'</span>, <span class="st">'s2'</span>, <span class="st">'s3'</span>, <span class="st">'s4'</span>, <span class="st">'s5'</span>, <span class="st">'s6'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>trn,test,y_trn,y_test <span class="op">=</span> train_test_split(data.data, data.target, test_size<span class="op">=</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>trn.shape, test.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>((353, 10), (89, 10))</code></pre>
</div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> regr_metrics(act, pred):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (math.sqrt(metrics.mean_squared_error(act, pred)), </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>     metrics.mean_absolute_error(act, pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="how-did-sklearn-do-it" class="level3">
<h3 class="anchored" data-anchor-id="how-did-sklearn-do-it">How did sklearn do it?</h3>
<p>How is sklearn doing this? By checking <a href="https://github.com/scikit-learn/scikit-learn/blob/14031f6/sklearn/linear_model/base.py#L417">the source code</a>, you can see that in the dense case, it calls <a href="https://github.com/scipy/scipy/blob/v0.19.0/scipy/linalg/basic.py#L892-L1058">scipy.linalg.lstqr</a>, which is calling a LAPACK method:</p>
<pre><code>    Options are ``'gelsd'``, ``'gelsy'``, ``'gelss'``. Default
    (``'gelsd'``) is a good choice.  However, ``'gelsy'`` can be slightly
    faster on many problems.  ``'gelss'`` was used historically.  It is
    generally slow but uses less memory.</code></pre>
<ul>
<li><a href="https://software.intel.com/sites/products/documentation/doclib/mkl_sa/11/mkl_lapack_examples/_gelsd.htm">gelsd</a>: uses SVD and a divide-and-conquer method</li>
<li><a href="https://software.intel.com/en-us/node/521113">gelsy</a>: uses QR factorization</li>
<li><a href="https://software.intel.com/en-us/node/521114">gelss</a>: uses SVD</li>
</ul>
<section id="scipy-sparse-least-squares" class="level4">
<h4 class="anchored" data-anchor-id="scipy-sparse-least-squares">Scipy Sparse Least Squares</h4>
<p>We will not get into too much detail about the sparse version of least squares. Here is a bit of info if you are interested:</p>
<p><a href="https://docs.scipy.org/doc/scipy-0.14.0/reference/generated/scipy.sparse.linalg.lsqr.html#id1">Scipy sparse lsqr</a> uses an iterative method called <a href="https://web.stanford.edu/class/cme324/paige-saunders2.pdf">Golub and Kahan bidiagonalization</a>.</p>
<p>from <a href="https://github.com/scipy/scipy/blob/v0.14.0/scipy/sparse/linalg/isolve/lsqr.py#L96">scipy sparse lsqr source code</a>: Preconditioning is another way to reduce the number of iterations. If it is possible to solve a related system <code>M*x = b</code> efficiently, where M approximates A in some helpful way (e.g.&nbsp;M - A has low rank or its elements are small relative to those of A), LSQR may converge more rapidly on the system <code>A*M(inverse)*z = b</code>, after which x can be recovered by solving M*x = z.</p>
<p>If A is symmetric, LSQR should not be used! Alternatives are the symmetric conjugate-gradient method (cg) and/or SYMMLQ. SYMMLQ is an implementation of symmetric cg that applies to any symmetric A and will converge more rapidly than LSQR. If A is positive definite, there are other implementations of symmetric cg that require slightly less work per iteration than SYMMLQ (but will take the same number of iterations).</p>
</section>
</section>
<section id="linalg.lstqr" class="level3">
<h3 class="anchored" data-anchor-id="linalg.lstqr">linalg.lstqr</h3>
<p>The sklearn implementation handled adding a constant term (since the y-intercept is presumably not 0 for the line we are learning) for us. We will need to do that by hand now:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>trn_int <span class="op">=</span> np.c_[trn, np.ones(trn.shape[<span class="dv">0</span>])]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>test_int <span class="op">=</span> np.c_[test, np.ones(test.shape[<span class="dv">0</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since <code>linalg.lstsq</code> lets us specify which LAPACK routine we want to use, lets try them all and do some timing comparisons:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>290 µs ± 9.24 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>140 µs ± 91.7 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>199 µs ± 228 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)</code></pre>
</div>
</div>
</section>
<section id="naive-solution" class="level3">
<h3 class="anchored" data-anchor-id="naive-solution">Naive Solution</h3>
<p>Recall that we want to find <span class="math inline">\(\hat{x}\)</span> that minimizes: <span class="math display">\[ \big\vert\big\vert Ax - b \big\vert\big\vert_2\]</span></p>
<p>Another way to think about this is that we are interested in where vector <span class="math inline">\(b\)</span> is closest to the subspace spanned by <span class="math inline">\(A\)</span> (called the <em>range of</em> <span class="math inline">\(A\)</span>). This is the projection of <span class="math inline">\(b\)</span> onto <span class="math inline">\(A\)</span>. Since <span class="math inline">\(b - A\hat{x}\)</span> must be perpendicular to the subspace spanned by <span class="math inline">\(A\)</span>, we see that</p>
<p><span class="math display">\[A^T (b - A\hat{x}) = 0 \]</span></p>
<p>(we are using <span class="math inline">\(A^T\)</span> because we want to multiply each column of <span class="math inline">\(A\)</span> by <span class="math inline">\(b - A\hat{x}\)</span></p>
<p>This leads us to the <em>normal equations</em>: <span class="math display">\[ x = (A^TA)^{-1}A^T b \]</span></p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ls_naive(A, b):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>     <span class="cf">return</span> np.linalg.inv(A.T <span class="op">@</span> A) <span class="op">@</span> A.T <span class="op">@</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>45.8 µs ± 4.65 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>coeffs_naive <span class="op">=</span> ls_naive(trn_int, y_trn)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>regr_metrics(y_test, test_int <span class="op">@</span> coeffs_naive)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(57.94102134545707, 48.053565198516438)</code></pre>
</div>
</div>
</section>
<section id="normal-equations-cholesky" class="level3">
<h3 class="anchored" data-anchor-id="normal-equations-cholesky">Normal Equations (Cholesky)</h3>
<p>Normal equations: <span class="math display">\[ A^TA x = A^T b \]</span></p>
<p>If <span class="math inline">\(A\)</span> has full rank, the pseudo-inverse <span class="math inline">\((A^TA)^{-1}A^T\)</span> is a <strong>square, hermitian positive definite</strong> matrix. The standard way of solving such a system is <em>Cholesky Factorization</em>, which finds upper-triangular R s.t. <span class="math inline">\(A^TA = R^TR\)</span>.</p>
<p>The following steps are based on Algorithm 11.1 from Trefethen:</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> trn_int</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> y_trn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>AtA <span class="op">=</span> A.T <span class="op">@</span> A</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Atb <span class="op">=</span> A.T <span class="op">@</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Warning:</strong> Numpy and Scipy default to different upper/lower for Cholesky</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> scipy.linalg.cholesky(AtA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(suppress<span class="op">=</span><span class="va">True</span>, precision<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="196">
<pre><code>array([[  0.9124,   0.1438,   0.1511,   0.3002,   0.2228,   0.188 ,
         -0.051 ,   0.1746,   0.22  ,   0.2768,  -0.2583],
       [  0.    ,   0.8832,   0.0507,   0.1826,  -0.0251,   0.0928,
         -0.3842,   0.2999,   0.0911,   0.15  ,   0.4393],
       [  0.    ,   0.    ,   0.8672,   0.2845,   0.2096,   0.2153,
         -0.2695,   0.3181,   0.3387,   0.2894,  -0.005 ],
       [  0.    ,   0.    ,   0.    ,   0.7678,   0.0762,  -0.0077,
          0.0383,   0.0014,   0.165 ,   0.166 ,   0.0234],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.8288,   0.7381,
          0.1145,   0.4067,   0.3494,   0.158 ,  -0.2826],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.3735,
         -0.3891,   0.2492,  -0.3245,  -0.0323,  -0.1137],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
          0.6406,  -0.511 ,  -0.5234,  -0.172 ,  -0.9392],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
          0.    ,   0.2887,  -0.0267,  -0.0062,   0.0643],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
          0.    ,   0.    ,   0.2823,   0.0636,   0.9355],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
          0.    ,   0.    ,   0.    ,   0.7238,   0.0202],
       [  0.    ,   0.    ,   0.    ,   0.    ,   0.    ,   0.    ,
          0.    ,   0.    ,   0.    ,   0.    ,  18.7319]])</code></pre>
</div>
</div>
<p>check our factorization:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>np.linalg.norm(AtA <span class="op">-</span> R.T <span class="op">@</span> R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>4.5140158187158533e-16</code></pre>
</div>
</div>
<p><span class="math display">\[ A^T A x = A^T b \]</span> <span class="math display">\[ R^T R x = A^T b \]</span> <span class="math display">\[ R^T w = A^T b \]</span> <span class="math display">\[ R x = w \]</span></p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> scipy.linalg.solve_triangular(R, Atb, lower<span class="op">=</span><span class="va">False</span>, trans<span class="op">=</span><span class="st">'T'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s always good to check that our result is what we expect it to be: (in case we entered the wrong params, the function didn’t return what we thought, or sometimes the docs are even outdated)</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>np.linalg.norm(R.T <span class="op">@</span> w <span class="op">-</span> Atb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>1.1368683772161603e-13</code></pre>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>coeffs_chol <span class="op">=</span> scipy.linalg.solve_triangular(R, w, lower<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>np.linalg.norm(R <span class="op">@</span> coeffs_chol <span class="op">-</span> w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>6.861429794408013e-14</code></pre>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ls_chol(A, b):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> scipy.linalg.cholesky(A.T <span class="op">@</span> A)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> scipy.linalg.solve_triangular(R, A.T <span class="op">@</span> b, trans<span class="op">=</span><span class="st">'T'</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scipy.linalg.solve_triangular(R, w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>111 µs ± 272 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>coeffs_chol <span class="op">=</span> ls_chol(trn_int, y_trn)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>regr_metrics(y_test, test_int <span class="op">@</span> coeffs_chol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>(57.9410213454571, 48.053565198516438)</code></pre>
</div>
</div>
</section>
<section id="qr-factorization" class="level3">
<h3 class="anchored" data-anchor-id="qr-factorization">QR Factorization</h3>
<p><span class="math display">\[ A x = b \]</span> <span class="math display">\[ A = Q R \]</span> <span class="math display">\[ Q R x = b \]</span></p>
<p><span class="math display">\[ R x = Q^T b \]</span></p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ls_qr(A,b):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    Q, R <span class="op">=</span> scipy.linalg.qr(A, mode<span class="op">=</span><span class="st">'economic'</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scipy.linalg.solve_triangular(R, Q.T <span class="op">@</span> b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>205 µs ± 264 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>coeffs_qr <span class="op">=</span> ls_qr(trn_int, y_trn)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>regr_metrics(y_test, test_int <span class="op">@</span> coeffs_qr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>(57.94102134545711, 48.053565198516452)</code></pre>
</div>
</div>
</section>
<section id="svd" class="level3">
<h3 class="anchored" data-anchor-id="svd">SVD</h3>
<p><span class="math display">\[ A x = b \]</span></p>
<p><span class="math display">\[ A = U \Sigma V \]</span></p>
<p><span class="math display">\[ \Sigma V x = U^T b \]</span></p>
<p><span class="math display">\[ \Sigma w = U^T b \]</span></p>
<p><span class="math display">\[ x = V^T w \]</span></p>
<p>SVD gives the pseudo-inverse</p>
<div class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ls_svd(A,b):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    m, n <span class="op">=</span> A.shape</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    U, sigma, Vh <span class="op">=</span> scipy.linalg.svd(A, full_matrices<span class="op">=</span><span class="va">False</span>, lapack_driver<span class="op">=</span><span class="st">'gesdd'</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> (U.T <span class="op">@</span> b)<span class="op">/</span> sigma</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Vh.T <span class="op">@</span> w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.11 ms ± 320 ns per loop (mean ± std. dev. of 7 runs, 1000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="254">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>266 µs ± 8.49 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="255">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>coeffs_svd <span class="op">=</span> ls_svd(trn_int, y_trn)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>regr_metrics(y_test, test_int <span class="op">@</span> coeffs_svd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="255">
<pre><code>(57.941021345457244, 48.053565198516687)</code></pre>
</div>
</div>
</section>
<section id="random-sketching-technique-for-least-squares-regression" class="level3">
<h3 class="anchored" data-anchor-id="random-sketching-technique-for-least-squares-regression">Random Sketching Technique for Least Squares Regression</h3>
<p><a href="http://researcher.watson.ibm.com/researcher/files/us-dpwoodru/journal.pdf">Linear Sketching</a> (Woodruff)</p>
<ol type="1">
<li>Sample a r x n random matrix S, r &lt;&lt; n</li>
<li>Compute S A and S b</li>
<li>Find exact solution x to regression SA x = Sb</li>
</ol>
</section>
<section id="timing-comparison" class="level3">
<h3 class="anchored" data-anchor-id="timing-comparison">Timing Comparison</h3>
<div class="cell" data-execution_count="244">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timeit</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="245">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> scipylstq(A, b):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scipy.linalg.lstsq(A,b)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="246">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>row_names <span class="op">=</span> [<span class="st">'Normal Eqns- Naive'</span>,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Normal Eqns- Cholesky'</span>, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>, </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>, </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>]</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>name2func <span class="op">=</span> {<span class="st">'Normal Eqns- Naive'</span>: <span class="st">'ls_naive'</span>, </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Normal Eqns- Cholesky'</span>: <span class="st">'ls_chol'</span>, </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>: <span class="st">'ls_qr'</span>,</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>: <span class="st">'ls_svd'</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>: <span class="st">'scipylstq'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="247">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>m_array <span class="op">=</span> np.array([<span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">10000</span>])</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>n_array <span class="op">=</span> np.array([<span class="dv">20</span>, <span class="dv">100</span>, <span class="dv">1000</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="248">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>index <span class="op">=</span> pd.MultiIndex.from_product([m_array, n_array], names<span class="op">=</span>[<span class="st">'# rows'</span>, <span class="st">'# cols'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="249">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'{:,.6f}'</span>.<span class="bu">format</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>row_names, columns<span class="op">=</span>index)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>df_error <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>row_names, columns<span class="op">=</span>index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="256">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %%prun</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> m_array:</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n <span class="kw">in</span> n_array:</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> m <span class="op">&gt;=</span> n:        </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">10</span>,<span class="dv">10</span>,n)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>            A <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">40</span>,<span class="dv">40</span>,[m,n])   <span class="co"># removed np.asfortranarray</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>            b <span class="op">=</span> np.matmul(A, x) <span class="op">+</span> np.random.normal(<span class="dv">0</span>,<span class="dv">2</span>,m)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name <span class="kw">in</span> row_names:</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                fcn <span class="op">=</span> name2func[name]</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                t <span class="op">=</span> timeit.timeit(fcn <span class="op">+</span> <span class="st">'(A,b)'</span>, number<span class="op">=</span><span class="dv">5</span>, <span class="bu">globals</span><span class="op">=</span><span class="bu">globals</span>())</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>                df.set_value(name, (m,n), t)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>                coeffs <span class="op">=</span> <span class="bu">locals</span>()[fcn](A, b)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>                reg_met <span class="op">=</span> regr_metrics(b, A <span class="op">@</span> coeffs)</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>                df_error.set_value(name, (m,n), reg_met[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="257">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="257">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th># rows</th>
      <th colspan="3" halign="left">100</th>
      <th colspan="3" halign="left">1000</th>
      <th colspan="3" halign="left">10000</th>
    </tr>
    <tr>
      <th># cols</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>0.001276</td>
      <td>0.003634</td>
      <td>NaN</td>
      <td>0.000960</td>
      <td>0.005172</td>
      <td>0.293126</td>
      <td>0.002226</td>
      <td>0.021248</td>
      <td>1.164655</td>
    </tr>
    <tr>
      <th>Normal Eqns- Cholesky</th>
      <td>0.001660</td>
      <td>0.003958</td>
      <td>NaN</td>
      <td>0.001665</td>
      <td>0.004007</td>
      <td>0.093696</td>
      <td>0.001928</td>
      <td>0.010456</td>
      <td>0.399464</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>0.002174</td>
      <td>0.006486</td>
      <td>NaN</td>
      <td>0.004235</td>
      <td>0.017773</td>
      <td>0.213232</td>
      <td>0.019229</td>
      <td>0.116122</td>
      <td>2.208129</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>0.003880</td>
      <td>0.021737</td>
      <td>NaN</td>
      <td>0.004672</td>
      <td>0.026950</td>
      <td>1.280490</td>
      <td>0.018138</td>
      <td>0.130652</td>
      <td>3.433003</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>0.004338</td>
      <td>0.020198</td>
      <td>NaN</td>
      <td>0.004320</td>
      <td>0.021199</td>
      <td>1.083804</td>
      <td>0.012200</td>
      <td>0.088467</td>
      <td>2.134780</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="252">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>df_error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="252">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th># rows</th>
      <th colspan="3" halign="left">100</th>
      <th colspan="3" halign="left">1000</th>
      <th colspan="3" halign="left">10000</th>
    </tr>
    <tr>
      <th># cols</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>1.702742</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>1.970767</td>
      <td>1.904873</td>
      <td>0.000000</td>
      <td>1.978383</td>
      <td>1.980449</td>
      <td>1.884440</td>
    </tr>
    <tr>
      <th>Normal Eqns- Cholesky</th>
      <td>1.702742</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>1.970767</td>
      <td>1.904873</td>
      <td>0.000000</td>
      <td>1.978383</td>
      <td>1.980449</td>
      <td>1.884440</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>1.702742</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>1.970767</td>
      <td>1.904873</td>
      <td>0.000000</td>
      <td>1.978383</td>
      <td>1.980449</td>
      <td>1.884440</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>1.702742</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>1.970767</td>
      <td>1.904873</td>
      <td>0.000000</td>
      <td>1.978383</td>
      <td>1.980449</td>
      <td>1.884440</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>1.702742</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>1.970767</td>
      <td>1.904873</td>
      <td>0.000000</td>
      <td>1.978383</td>
      <td>1.980449</td>
      <td>1.884440</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="618">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>store <span class="op">=</span> pd.HDFStore(<span class="st">'least_squares_results.h5'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="619">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>store[<span class="st">'df'</span>] <span class="op">=</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\rache\Anaconda3\lib\site-packages\IPython\core\interactiveshell.py:2881: PerformanceWarning: 
your performance may suffer as PyTables will pickle object types that it cannot
map directly to c-types [inferred_type-&gt;floating,key-&gt;block0_values] [items-&gt;[(100, 20), (100, 100), (100, 1000), (1000, 20), (1000, 100), (1000, 1000), (5000, 20), (5000, 100), (5000, 1000)]]

  exec(code_obj, self.user_global_ns, self.user_ns)</code></pre>
</div>
</div>
</section>
<section id="notes" class="level2">
<h2 class="anchored" data-anchor-id="notes">Notes</h2>
<p>I used the magick %prun to profile my code.</p>
<p>Alternative: least absolute deviation (L1 regression) - Less sensitive to outliers than least squares. - No closed form solution, but can solve with linear programming</p>
</section>
<section id="conditioning-stability" class="level2">
<h2 class="anchored" data-anchor-id="conditioning-stability">Conditioning &amp; stability</h2>
<section id="condition-number" class="level4">
<h4 class="anchored" data-anchor-id="condition-number">Condition Number</h4>
<p><em>Condition number</em> is a measure of how small changes to the input cause the output to change.</p>
<p><strong>Question</strong>: Why do we care about behavior with small changes to the input in numerical linear algebra?</p>
<p>The <em>relative condition number</em> is defined by</p>
<p><span class="math display">\[ \kappa = \sup_{\delta x} \frac{\|\delta f\|}{\| f(x) \|}\bigg/ \frac{\| \delta x \|}{\| x \|} \]</span></p>
<p>where <span class="math inline">\(\delta x\)</span> is infinitesimal</p>
<p>According to Trefethen (pg. 91), a problem is <em>well-conditioned</em> if <span class="math inline">\(\kappa\)</span> is small (e.g.&nbsp;<span class="math inline">\(1\)</span>, <span class="math inline">\(10\)</span>, <span class="math inline">\(10^2\)</span>) and <em>ill-conditioned</em> if <span class="math inline">\(\kappa\)</span> is large (e.g.&nbsp;<span class="math inline">\(10^6\)</span>, <span class="math inline">\(10^{16}\)</span>)</p>
<p><strong>Conditioning</strong>: perturbation behavior of a mathematical problem (e.g.&nbsp;least squares)</p>
<p><strong>Stability</strong>: perturbation behavior of an algorithm used to solve that problem on a computer (e.g.&nbsp;least squares algorithms, householder, back substitution, gaussian elimination)</p>
</section>
<section id="conditioning-example" class="level4">
<h4 class="anchored" data-anchor-id="conditioning-example">Conditioning example</h4>
<p>The problem of computing eigenvalues of a non-symmetric matrix is often ill-conditioned</p>
<div class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> [[<span class="dv">1</span>, <span class="dv">1000</span>], [<span class="dv">0</span>, <span class="dv">1</span>]]</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> [[<span class="dv">1</span>, <span class="dv">1000</span>], [<span class="fl">0.001</span>, <span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>wA, vrA <span class="op">=</span> scipy.linalg.eig(A)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>wB, vrB <span class="op">=</span> scipy.linalg.eig(B)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>wA, wB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="180">
<pre><code>(array([ 1.+0.j,  1.+0.j]),
 array([  2.00000000e+00+0.j,  -2.22044605e-16+0.j]))</code></pre>
</div>
</div>
</section>
<section id="condition-number-of-a-matrix" class="level4">
<h4 class="anchored" data-anchor-id="condition-number-of-a-matrix">Condition Number of a Matrix</h4>
<p>The product <span class="math inline">\(\| A\| \|A^{-1} \|\)</span> comes up so often it has its own name: the <em>condition number</em> of <span class="math inline">\(A\)</span>. Note that normally we talk about the conditioning of problems, not matrices.</p>
<p>The <em>condition number</em> of <span class="math inline">\(A\)</span> relates to: - computing <span class="math inline">\(b\)</span> given <span class="math inline">\(A\)</span> and <span class="math inline">\(x\)</span> in <span class="math inline">\(Ax = b\)</span> - computing <span class="math inline">\(x\)</span> given <span class="math inline">\(A\)</span> and <span class="math inline">\(b\)</span> in <span class="math inline">\(Ax = b\)</span></p>
</section>
</section>
<section id="loose-ends-from-last-time" class="level2">
<h2 class="anchored" data-anchor-id="loose-ends-from-last-time">Loose ends from last time</h2>
<section id="full-vs-reduced-factorizations" class="level3">
<h3 class="anchored" data-anchor-id="full-vs-reduced-factorizations">Full vs Reduced Factorizations</h3>
<p><strong>SVD</strong></p>
<p>Diagrams from Trefethen:</p>
<p><img src="images/full_svd.JPG" alt="" style="width: 80%"></p>
<p><img src="images/reduced_svd.JPG" alt="" style="width: 70%"></p>
<p><strong>QR Factorization exists for ALL matrices</strong></p>
<p>Just like with SVD, there are full and reduced versions of the QR factorization.</p>
<p><img src="images/full_qr.JPG" alt="" style="width: 70%"></p>
<p><img src="images/reduced_qr.JPG" alt="" style="width: 70%"></p>
</section>
<section id="matrix-inversion-is-unstable" class="level3">
<h3 class="anchored" data-anchor-id="matrix-inversion-is-unstable">Matrix Inversion is Unstable</h3>
<div class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.linalg <span class="im">import</span> hilbert</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="229">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">14</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> hilbert(n)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">10</span>,<span class="dv">10</span>,n)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> A <span class="op">@</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="230">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>A_inv <span class="op">=</span> np.linalg.inv(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="233">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>np.linalg.norm(np.eye(n) <span class="op">-</span> A <span class="op">@</span> A_inv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="233">
<pre><code>5.0516495470543212</code></pre>
</div>
</div>
<div class="cell" data-execution_count="231">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>np.linalg.cond(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="231">
<pre><code>2.2271635826494112e+17</code></pre>
</div>
</div>
<div class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">@</span> A_inv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="232">
<pre><code>array([[ 1.    ,  0.    , -0.0001,  0.0005, -0.0006,  0.0105, -0.0243,
         0.1862, -0.6351,  2.2005, -0.8729,  0.8925, -0.0032, -0.0106],
       [ 0.    ,  1.    , -0.    ,  0.    ,  0.0035,  0.0097, -0.0408,
         0.0773, -0.0524,  1.6926, -0.7776, -0.111 , -0.0403, -0.0184],
       [ 0.    ,  0.    ,  1.    ,  0.0002,  0.0017,  0.0127, -0.0273,
         0.    ,  0.    ,  1.4688, -0.5312,  0.2812,  0.0117,  0.0264],
       [ 0.    ,  0.    , -0.    ,  1.0005,  0.0013,  0.0098, -0.0225,
         0.1555, -0.0168,  1.1571, -0.9656, -0.0391,  0.018 , -0.0259],
       [-0.    ,  0.    , -0.    ,  0.0007,  1.0001,  0.0154,  0.011 ,
        -0.2319,  0.5651, -0.2017,  0.2933, -0.6565,  0.2835, -0.0482],
       [ 0.    , -0.    ,  0.    , -0.0004,  0.0059,  0.9945, -0.0078,
        -0.0018, -0.0066,  1.1839, -0.9919,  0.2144, -0.1866,  0.0187],
       [-0.    ,  0.    , -0.    ,  0.0009, -0.002 ,  0.0266,  0.974 ,
        -0.146 ,  0.1883, -0.2966,  0.4267, -0.8857,  0.2265, -0.0453],
       [ 0.    ,  0.    , -0.    ,  0.0002,  0.0009,  0.0197, -0.0435,
         1.1372, -0.0692,  0.7691, -1.233 ,  0.1159, -0.1766, -0.0033],
       [ 0.    ,  0.    , -0.    ,  0.0002,  0.    , -0.0018, -0.0136,
         0.1332,  0.945 ,  0.3652, -0.2478, -0.1682,  0.0756, -0.0212],
       [ 0.    , -0.    , -0.    ,  0.0003,  0.0038, -0.0007,  0.0318,
        -0.0738,  0.2245,  1.2023, -0.2623, -0.2783,  0.0486, -0.0093],
       [-0.    ,  0.    , -0.    ,  0.0004, -0.0006,  0.013 , -0.0415,
         0.0292, -0.0371,  0.169 ,  1.0715, -0.09  ,  0.1668, -0.0197],
       [ 0.    , -0.    ,  0.    ,  0.    ,  0.0016,  0.0062, -0.0504,
         0.1476, -0.2341,  0.8454, -0.7907,  1.4812, -0.15  ,  0.0186],
       [ 0.    , -0.    ,  0.    , -0.0001,  0.0022,  0.0034, -0.0296,
         0.0944, -0.1833,  0.6901, -0.6526,  0.2556,  0.8563,  0.0128],
       [ 0.    ,  0.    ,  0.    , -0.0001,  0.0018, -0.0041, -0.0057,
        -0.0374, -0.165 ,  0.3968, -0.2264, -0.1538, -0.0076,  1.005 ]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>row_names <span class="op">=</span> [<span class="st">'Normal Eqns- Naive'</span>,</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>, </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>, </span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>]</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>name2func <span class="op">=</span> {<span class="st">'Normal Eqns- Naive'</span>: <span class="st">'ls_naive'</span>, </span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>: <span class="st">'ls_qr'</span>,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>: <span class="st">'ls_svd'</span>,</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>: <span class="st">'scipylstq'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'{:,.9f}'</span>.<span class="bu">format</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>row_names, columns<span class="op">=</span>[<span class="st">'Time'</span>, <span class="st">'Error'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> row_names:</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    fcn <span class="op">=</span> name2func[name]</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> timeit.timeit(fcn <span class="op">+</span> <span class="st">'(A,b)'</span>, number<span class="op">=</span><span class="dv">5</span>, <span class="bu">globals</span><span class="op">=</span><span class="bu">globals</span>())</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    coeffs <span class="op">=</span> <span class="bu">locals</span>()[fcn](A, b)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    df.set_value(name, <span class="st">'Time'</span>, t)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    df.set_value(name, <span class="st">'Error'</span>, regr_metrics(b, A <span class="op">@</span> coeffs)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="svd-is-best-here" class="level4">
<h4 class="anchored" data-anchor-id="svd-is-best-here">SVD is best here!</h4>
<p>DO NOT RERUN</p>
<div class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="240">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Time</th>
      <th>Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>0.001334339</td>
      <td>3.598901966</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>0.002166139</td>
      <td>0.000000000</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>0.001556937</td>
      <td>0.000000000</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>0.001871590</td>
      <td>0.000000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="240">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Time</th>
      <th>Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>0.001334339</td>
      <td>3.598901966</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>0.002166139</td>
      <td>0.000000000</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>0.001556937</td>
      <td>0.000000000</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>0.001871590</td>
      <td>0.000000000</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p><strong>Another reason not to take inverse</strong></p>
<p>Even if <span class="math inline">\(A\)</span> is incredibly sparse, <span class="math inline">\(A^{-1}\)</span> is generally dense. For large matrices, <span class="math inline">\(A^{-1}\)</span> could be so dense as to not fit in memory.</p>
</section>
</section>
</section>
<section id="runtime" class="level2">
<h2 class="anchored" data-anchor-id="runtime">Runtime</h2>
<p>Matrix Inversion: <span class="math inline">\(2n^3\)</span></p>
<p>Matrix Multiplication: <span class="math inline">\(n^3\)</span></p>
<p>Cholesky: <span class="math inline">\(\frac{1}{3}n^3\)</span></p>
<p>QR, Gram Schmidt: <span class="math inline">\(2mn^2\)</span>, <span class="math inline">\(m\geq n\)</span> (chapter 8 of Trefethen)</p>
<p>QR, Householder: <span class="math inline">\(2mn^2 - \frac{2}{3}n^3\)</span> (chapter 10 of Trefethen)</p>
<p>Solving a triangular system: <span class="math inline">\(n^2\)</span></p>
<p><strong>Why Cholesky Factorization is Fast:</strong></p>
<p><img src="images/cholesky_factorization_speed.png" alt="" style="width: 100%"> (source: <a href="http://stanford.edu/class/ee364a/lectures/num-lin-alg.pdf">Stanford Convex Optimization: Numerical Linear Algebra Background Slides</a>)</p>
<section id="a-case-where-qr-is-the-best" class="level3">
<h3 class="anchored" data-anchor-id="a-case-where-qr-is-the-best">A Case Where QR is the Best</h3>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>m<span class="op">=</span><span class="dv">100</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>n<span class="op">=</span><span class="dv">15</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>t<span class="op">=</span>np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vandermonde matrix</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>A<span class="op">=</span>np.stack([t<span class="op">**</span>i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)], <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>b<span class="op">=</span>np.exp(np.sin(<span class="dv">4</span><span class="op">*</span>t))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This will turn out to normalize the solution to be 1</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>b <span class="op">/=</span> <span class="fl">2006.787453080206</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>plt.plot(t, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="6.%20How%20to%20Implement%20Linear%20Regression_files/figure-html/cell-65-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Check that we get 1:</p>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="op">-</span> ls_qr(A, b)[<span class="dv">14</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>1.4137685733217609e-07</code></pre>
</div>
</div>
<p>Bad condition number:</p>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>kappa <span class="op">=</span> np.linalg.cond(A)<span class="op">;</span> kappa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>5.827807196683593e+17</code></pre>
</div>
</div>
<div class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>row_names <span class="op">=</span> [<span class="st">'Normal Eqns- Naive'</span>,</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>, </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>, </span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>]</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>name2func <span class="op">=</span> {<span class="st">'Normal Eqns- Naive'</span>: <span class="st">'ls_naive'</span>, </span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>: <span class="st">'ls_qr'</span>,</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>: <span class="st">'ls_svd'</span>,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>: <span class="st">'scipylstq'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'{:,.9f}'</span>.<span class="bu">format</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>row_names, columns<span class="op">=</span>[<span class="st">'Time'</span>, <span class="st">'Error'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> row_names:</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    fcn <span class="op">=</span> name2func[name]</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> timeit.timeit(fcn <span class="op">+</span> <span class="st">'(A,b)'</span>, number<span class="op">=</span><span class="dv">5</span>, <span class="bu">globals</span><span class="op">=</span><span class="bu">globals</span>())</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    coeffs <span class="op">=</span> <span class="bu">locals</span>()[fcn](A, b)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    df.set_value(name, <span class="st">'Time'</span>, t)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    df.set_value(name, <span class="st">'Error'</span>, np.<span class="bu">abs</span>(<span class="dv">1</span> <span class="op">-</span> coeffs[<span class="op">-</span><span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="76">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Time</th>
      <th>Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>0.001565099</td>
      <td>1.357066025</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>0.002632104</td>
      <td>0.000000116</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>0.003503785</td>
      <td>0.000000116</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>0.002763502</td>
      <td>0.000000116</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>The solution for least squares via the normal equations is unstable in general, although stable for problems with small condition numbers.</p>
</section>
<section id="low-rank" class="level3">
<h3 class="anchored" data-anchor-id="low-rank">Low-rank</h3>
<div class="cell" data-execution_count="258">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">10</span>,<span class="dv">10</span>,n)</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>A2 <span class="op">=</span> np.random.uniform(<span class="op">-</span><span class="dv">40</span>,<span class="dv">40</span>, [m, <span class="bu">int</span>(n<span class="op">/</span><span class="dv">2</span>)])   <span class="co"># removed np.asfortranarray</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> np.hstack([A2, A2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="259">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>A.shape, A2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="259">
<pre><code>((100, 10), (100, 5))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="260">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> A <span class="op">@</span> x <span class="op">+</span> np.random.normal(<span class="dv">0</span>,<span class="dv">1</span>,m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="263">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>row_names <span class="op">=</span> [<span class="st">'Normal Eqns- Naive'</span>,</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>, </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>, </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>]</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>name2func <span class="op">=</span> {<span class="st">'Normal Eqns- Naive'</span>: <span class="st">'ls_naive'</span>, </span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">'QR Factorization'</span>: <span class="st">'ls_qr'</span>,</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">'SVD'</span>: <span class="st">'ls_svd'</span>,</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Scipy lstsq'</span>: <span class="st">'scipylstq'</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="264">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>pd.options.display.float_format <span class="op">=</span> <span class="st">'{:,.9f}'</span>.<span class="bu">format</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>row_names, columns<span class="op">=</span>[<span class="st">'Time'</span>, <span class="st">'Error'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="265">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> row_names:</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    fcn <span class="op">=</span> name2func[name]</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> timeit.timeit(fcn <span class="op">+</span> <span class="st">'(A,b)'</span>, number<span class="op">=</span><span class="dv">5</span>, <span class="bu">globals</span><span class="op">=</span><span class="bu">globals</span>())</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    coeffs <span class="op">=</span> <span class="bu">locals</span>()[fcn](A, b)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    df.set_value(name, <span class="st">'Time'</span>, t)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    df.set_value(name, <span class="st">'Error'</span>, regr_metrics(b, A <span class="op">@</span> coeffs)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="266">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="266">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Time</th>
      <th>Error</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>0.001227640</td>
      <td>300.658979382</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>0.002315920</td>
      <td>0.876019803</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>0.001745647</td>
      <td>1.584746056</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>0.002067989</td>
      <td>0.804750398</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="comparison" class="level2">
<h2 class="anchored" data-anchor-id="comparison">Comparison</h2>
<p>Our results from above:</p>
<div class="cell" data-execution_count="257">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="257">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th># rows</th>
      <th colspan="3" halign="left">100</th>
      <th colspan="3" halign="left">1000</th>
      <th colspan="3" halign="left">10000</th>
    </tr>
    <tr>
      <th># cols</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
      <th>20</th>
      <th>100</th>
      <th>1000</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Normal Eqns- Naive</th>
      <td>0.001276</td>
      <td>0.003634</td>
      <td>NaN</td>
      <td>0.000960</td>
      <td>0.005172</td>
      <td>0.293126</td>
      <td>0.002226</td>
      <td>0.021248</td>
      <td>1.164655</td>
    </tr>
    <tr>
      <th>Normal Eqns- Cholesky</th>
      <td>0.001660</td>
      <td>0.003958</td>
      <td>NaN</td>
      <td>0.001665</td>
      <td>0.004007</td>
      <td>0.093696</td>
      <td>0.001928</td>
      <td>0.010456</td>
      <td>0.399464</td>
    </tr>
    <tr>
      <th>QR Factorization</th>
      <td>0.002174</td>
      <td>0.006486</td>
      <td>NaN</td>
      <td>0.004235</td>
      <td>0.017773</td>
      <td>0.213232</td>
      <td>0.019229</td>
      <td>0.116122</td>
      <td>2.208129</td>
    </tr>
    <tr>
      <th>SVD</th>
      <td>0.003880</td>
      <td>0.021737</td>
      <td>NaN</td>
      <td>0.004672</td>
      <td>0.026950</td>
      <td>1.280490</td>
      <td>0.018138</td>
      <td>0.130652</td>
      <td>3.433003</td>
    </tr>
    <tr>
      <th>Scipy lstsq</th>
      <td>0.004338</td>
      <td>0.020198</td>
      <td>NaN</td>
      <td>0.004320</td>
      <td>0.021199</td>
      <td>1.083804</td>
      <td>0.012200</td>
      <td>0.088467</td>
      <td>2.134780</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<p>From Trefethen (page 84):</p>
<p>Normal equations/Cholesky is fastest when it works. Cholesky can only be used on symmetric, positive definite matrices. Also, normal equations/Cholesky is unstable for matrices with high condition numbers or with low-rank.</p>
<p>Linear regression via QR has been recommended by numerical analysts as the standard method for years. It is natural, elegant, and good for “daily use”.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>